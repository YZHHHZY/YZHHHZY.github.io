<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/%E5%8D%9A%E5%AE%A2.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/%E5%8D%9A%E5%AE%A2-copy.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="so逆向分析">
<meta property="og:type" content="article">
<meta property="og:title" content="逆向学习 0x0C so逆向分析">
<meta property="og:url" content="http://example.com/2025/07/24/%E9%80%86%E5%90%91%E5%AD%A6%E4%B9%A0-0x0C-so%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="妙妙屋">
<meta property="og:description" content="so逆向分析">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2025/07/24/%E5%9B%BE%E7%89%87/image-20241119200211946-1753337619550-1.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20241119201034054-1753337619550-2.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250317190338898.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250317190446640.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250317191112196.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250317191213640.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250317192908916.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250318102521222.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250318110627196.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250318112130502.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250318112728608.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250318113128487.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250318113831651.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250318114148694.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250318114233715.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250318115036757.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250318173557336.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250318175226280.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250318203725878.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250318204103612.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250319191748542.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250319192311296.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250319192349922.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250319192643930.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250319195728415.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250319203646060.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250319210023411.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250319212048747.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250319212351692.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250319213927557.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250320184541264.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250320185454584.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250320191238238.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250320191502608.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250320194425926.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250322192251632.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250322194011120.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250322201329904.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250322201233593.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250322202602752.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250322203339145.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250322210037646.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250322212112068.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250326191154833.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250326192113496.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250326200345200.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250326201535820.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250326201805424.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250326202743143.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250326204709972.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250326205159753.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250326205234734.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250326205818222.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250326210108258.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250328085949170.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250328090712978.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250328093112872.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250328213852049.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250329144646183.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250329144835438.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250329165504941.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250329170340012.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250329190809624.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250329191238781.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250329191400817.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250330172148686.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250331163934726.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250331172720113.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250331173732081.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250331191331466.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250401172536122.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250401183540864.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250401202642596.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250402110250128.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250402160118080.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250402160236638.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250402162511809.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250402164936392.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250402170520698.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250402173121170.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250402185945047.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250402191558203.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250402205425905.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250402211405820.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250507161605436.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250507161912573.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250507162401735.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250507162315845.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250507163243014.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250507164353078.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250507164807174.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250507173151163.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250508142513917.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250508143054019.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250517203007663.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250517203751335.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250517204316462.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250508184018725.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250508185153361.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250508192242651.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250508193835539.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250509085324392.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250509093543463.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250509113836112.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250509114635117.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250509114623082.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250509203720021.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250509204244280.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250509204314125.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250509204553714.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250509205115355.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250509205420488.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250509210243620.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250509210456894.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250509210844613.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250509212911045.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250509212529673.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250509213207012.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250509213813604.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250517194231089.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250517195136003.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250517195740682.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250518200334077.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250518205309392.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250518205457685.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250518213213690.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250519185710731.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250519191342968.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250519191559123.png">
<meta property="og:image" content="http://example.com/2025/07/24/%E5%9B%BE%E7%89%87/image-20250519192029777.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250519192754371.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250519201523928.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250519211502144.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250519212015469.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250519213431230.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250519215420099.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250519215329911.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250519215916472.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250519220254981.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250520175226846.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250520180644721.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250520180532824.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250520181224549.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250520181738858.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250520182000589.png">
<meta property="og:image" content="http://example.com/%E5%9B%BE%E7%89%87/image-20250520182549554.png">
<meta property="article:published_time" content="2025-07-24T06:12:28.000Z">
<meta property="article:modified_time" content="2025-07-24T06:15:29.440Z">
<meta property="article:author" content="没事数命的猫">
<meta property="article:tag" content="安卓逆向">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2025/07/24/%E5%9B%BE%E7%89%87/image-20241119200211946-1753337619550-1.png">

<link rel="canonical" href="http://example.com/2025/07/24/%E9%80%86%E5%90%91%E5%AD%A6%E4%B9%A0-0x0C-so%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>逆向学习 0x0C so逆向分析 | 妙妙屋</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">妙妙屋</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">思而不学则殆</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/24/%E9%80%86%E5%90%91%E5%AD%A6%E4%B9%A0-0x0C-so%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="没事数命的猫">
      <meta itemprop="description" content="学而不思则罔">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="妙妙屋">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          逆向学习 0x0C so逆向分析
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2025-07-24 14:12:28 / 修改时间：14:15:29" itemprop="dateCreated datePublished" datetime="2025-07-24T14:12:28+08:00">2025-07-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%80%86%E5%90%91%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">逆向学习</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>18k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1:05</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="so逆向分析"><a href="#so逆向分析" class="headerlink" title="so逆向分析"></a>so逆向分析</h2><span id="more"></span>

<p>先回忆一下NDK开发的时候分析的那个apk</p>
<p>抓个包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST /user/api/v1/login/app/mobile HTTP/1.1</span><br><span class="line">pa: MTczMjAxNzY1MzAzMyxhMTZhM2ZmOWVmYzU0M2IxYjlkMTBiMGI3NjY3NTk4MiwzZjg3MjNlMWNiMzBhYzYwM2RiYjY1ZGQ4N2QxMTA3Miw=</span><br><span class="line">appInfo: &#123;&quot;IMEI&quot;:&quot;bf1821d5634d0ec8&quot;,&quot;appBuild&quot;:&quot;21070602&quot;,&quot;appVersion&quot;:&quot;6.2.0&quot;,&quot;deviceId&quot;:&quot;bf1821d5634d0ec8&quot;,&quot;deviceName&quot;:&quot;NX627J&quot;,&quot;osType&quot;:&quot;android&quot;,&quot;osVersion&quot;:&quot;9&quot;,&quot;phoneName&quot;:&quot;NX627J&quot;,&quot;phoneSystemVersion&quot;:&quot;9&quot;,&quot;vendor&quot;:&quot;nubia&quot;&#125;</span><br><span class="line">User-Agent: PocketFans201807/6.2.0_21070602 (NX627J:Android 9;nubia PQ3B.190801.03191204 release-keys)</span><br><span class="line">Content-Type: application/json; charset=UTF-8</span><br><span class="line">Content-Length: 43</span><br><span class="line">Host: pocketapi.48.cn</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line">Accept-Encoding: gzip</span><br><span class="line"></span><br><span class="line">&#123;&quot;mobile&quot;:&quot;13112345678&quot;,&quot;pwd&quot;:&quot;a123123123&quot;&#125;</span><br></pre></td></tr></table></figure>

<img src="../图片/image-20241119200211946-1753337619550-1.png" alt="image-20241119200211946" style="zoom: 50%;" />



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">感觉只有 pa 字段值得注意， MT ey 开头的一般是base64</span><br><span class="line">MTczMjAxNzY1MzAzMyxhMTZhM2ZmOWVmYzU0M2IxYjlkMTBiMGI3NjY3NTk4MiwzZjg3MjNlMWNiMzBhYzYwM2RiYjY1ZGQ4N2QxMTA3Miw=</span><br><span class="line"></span><br><span class="line">base64解码</span><br><span class="line">1732017653033,a16a3ff9efc543b1b9d10b0b76675982,3f8723e1cb30ac603dbb65dd87d11072,</span><br><span class="line">看到有三节数据，第一节感觉像是时间戳</span><br></pre></td></tr></table></figure>

<p><img src="/../%E5%9B%BE%E7%89%87/image-20241119201034054-1753337619550-2.png" alt="image-20241119201034054"></p>
<p>那么直觉告诉我剩下两个就是账号和密码了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a16a3ff9efc543b1b9d10b0b76675982</span><br><span class="line">3f8723e1cb30ac603dbb65dd87d11072</span><br><span class="line">32位密文感觉和MD5有关，但是不完全是，可能加了什么东西</span><br></pre></td></tr></table></figure>



<p><img src="/../%E5%9B%BE%E7%89%87/image-20250317190338898.png" alt="image-20250317190338898"></p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250317190446640.png" alt="image-20250317190446640"></p>
<p>加载的是 encryptlib 这个so文件，解压出来，扔IDA中</p>
<p>从导出表内可以看到这个方法 <code>Java_com_pocket_snh48_base_net_utils_EncryptlibUtils_MD5</code> </p>
<p>可以看到初始化常量还要 0x80 的填充</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250317191112196.png" alt="image-20250317191112196"></p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250317191213640.png" alt="image-20250317191213640"></p>
<p>so层的分析就是hook关键函数，方法有六个参数，传进来四个，第一个是content是个对象，不用管，剩下三个字符串。分析的时候完全可以从下往上分析，return了 v39，v39是从result转换出来的，result显然是作为接收结果的参数传入 MakePassMD5 的，v48应该是content，v37和v38按照C语言的习惯应该是明文和明文长度，这个时候就可以尝试hook MakePassMD5</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250317192908916.png" alt="image-20250317192908916"></p>
<p>so层的hook只需要得到一个地址，有函数地址就能hook与主动调用</p>
<p>frida的Java层hook和so层hook的环境配置是一样的，直接写代码hook即可。</p>
<p>这个时候就需要考虑如何得到想要hook的函数的地址了，通过frida提供的api来获取地址，这个有一个 前提，就是该函数必须有符号才行（出现在符号表，导出表或者导入表中）。还可以通过计算来得到地址，如果这个函数没有符号，就只能通过计算地址来hook了：so基址+函数在so中的偏移[+1]。</p>
<h3 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h3><p>枚举获取so文件中导入表中的所有函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> improts = <span class="title class_">Module</span>.<span class="title function_">enumerateImports</span>(<span class="string">&#x27;libencryptlib.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; improts.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(improts[i]))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接打印的是object，需要转换成json类型的数据，里面包含函数的名字和地址，这个地址是在内存中的地址，不是偏移地址，偏移地址还需要这个地址-so基址，也可以光打印名称和地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">console.log(improts[i].name, improts[i].address)</span><br></pre></td></tr></table></figure>



<p><img src="/../%E5%9B%BE%E7%89%87/image-20250318102521222.png" alt="image-20250318102521222"></p>
<p>枚举导出表</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> improts = <span class="title class_">Module</span>.<span class="title function_">enumerateExports</span>(<span class="string">&#x27;libencryptlib.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; improts.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(improts[i]))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>枚举符号表</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> improts = <span class="title class_">Module</span>.<span class="title function_">enumerateSymbols</span>(<span class="string">&#x27;libencryptlib.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; improts.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(improts[i]))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>一般系统函数去枚举符号表，自定义的一些函数去枚举导出表即可</p>
<p>枚举模块，再枚举模块内的导出表，可以快速定位某个导入函数出自哪个so，一般用不上。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> moduel = <span class="title class_">Process</span>.<span class="title function_">enumerateModules</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(moduel[<span class="number">0</span>]));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(moduel[<span class="number">0</span>].<span class="title function_">enumerateExports</span>()[<span class="number">0</span>]));</span><br></pre></td></tr></table></figure>





<h3 id="hook导出函数"><a href="#hook导出函数" class="headerlink" title="hook导出函数"></a>hook导出函数</h3><p>以上文的 MakePassMM5 函数为例</p>
<p>hook导出表，搜索这个函数，获得函数名和地址</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250318110627196.png" alt="image-20250318110627196"></p>
<p>在导出表中的函数，也可以使用frida的API从IDA中拿函数名进行搜索地址</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 搜索地址</span></span><br><span class="line"><span class="keyword">var</span> funcAddress = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&#x27;libencryptlib.so&#x27;</span>, <span class="string">&#x27;_ZN7MD5_CTX11MakePassMD5EPhjS0_&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(funcAddress)</span><br></pre></td></tr></table></figure>



<p>得到函数地址之后就可以开始hook了，用 Interceptor.attach 来对函数进行hook，先传入要hook的地址，然后一个花括号，里面有两个方法，onEnter是在原函数执行前执行，onLeave在函数执行后执行</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据地址hook函数</span></span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(funcAddress, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<p>直接打印args的内容可能只有一个地址，或者只有一个十六进制数，可以利用 hexdump 函数去找这个地址对于的内容，十六进制数可以转换成十进制显示</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250318112130502.png" alt="image-20250318112130502"></p>
<p>按照之前的分析content不管他，只看 123</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(funcAddress, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[1]: \n&quot;</span> ,<span class="title function_">hexdump</span>(args[<span class="number">1</span>]));</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[2]: \n&quot;</span> ,args[<span class="number">2</span>].<span class="title function_">toInt32</span>());</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[3]: \n&quot;</span> ,<span class="title function_">hexdump</span>(args[<span class="number">3</span>]))</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;result: &quot;</span> ,retval, retval.<span class="title function_">toInt32</span>())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<p>args[1] 显然是需要去MD5加密的内容，args[2]是45，是上一个参数的长度。args[3]目前为空，准备接收加密结果</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250318112728608.png" alt="image-20250318112728608"></p>
<p>这个时候打印的返回值只有一个长度信息 32，我们需要看 args[3]，执行完毕之后的结果，这个时候需要提前将args[3]这块地址保存下来，在执行完毕之后再查看，出现MD5计算之后的结果</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据地址hook函数</span></span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(funcAddress, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[1]: \n&quot;</span> ,<span class="title function_">hexdump</span>(args[<span class="number">1</span>]));</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[2]: \n&quot;</span> ,args[<span class="number">2</span>].<span class="title function_">toInt32</span>());</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[3]: \n&quot;</span> ,<span class="title function_">hexdump</span>(args[<span class="number">3</span>]))</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">args3</span> = args[<span class="number">3</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;result: &quot;</span> ,<span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">args3</span>))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><img src="/../%E5%9B%BE%E7%89%87/image-20250318113128487.png" alt="image-20250318113128487"></p>
<p>得到了后面的加密出处，而且还要意外发现，入参 args[1] 就是前两个参数拼接起来的</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250318113831651.png" alt="image-20250318113831651"></p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250318114148694.png" alt="image-20250318114148694"></p>
<p>运算一下，也是标准的MD5</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250318114233715.png" alt="image-20250318114233715"></p>
<h3 id="模块基址的获取方式"><a href="#模块基址的获取方式" class="headerlink" title="模块基址的获取方式"></a>模块基址的获取方式</h3><p>如果函数没有出现在导出表、导入表、符号表内，就不能通过以上的frida的API来获取地址，只能通过计算来获取</p>
<p>地址：so基址+函数在so中的偏移[+1]</p>
<p>先获取so的基址</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取模块基址</span></span><br><span class="line"><span class="keyword">var</span> module1 = <span class="title class_">Process</span>.<span class="title function_">findModuleByName</span>(<span class="string">&#x27;libencryptlib.so&#x27;</span>)</span><br><span class="line"><span class="keyword">var</span> module2 = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&#x27;libencryptlib.so&#x27;</span>)</span><br><span class="line"><span class="keyword">var</span> module3 = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libencryptlib.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(module1.<span class="property">base</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(module2.<span class="property">base</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(module3)</span><br></pre></td></tr></table></figure>



<p>base就是基址</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250318115036757.png" alt="image-20250318115036757"></p>
<p>还可以用上文API获取所有模块，去遍历获取地址</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> moduel = <span class="title class_">Process</span>.<span class="title function_">enumerateModules</span>();</span><br></pre></td></tr></table></figure>



<p>还可以已知基址来寻找模块，找到模块即可去调用下述方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(address)</span><br><span class="line"><span class="title class_">Process</span>.<span class="title function_">getModuleByAddress</span>(address)</span><br></pre></td></tr></table></figure>





<h3 id="函数地址计算"><a href="#函数地址计算" class="headerlink" title="函数地址计算"></a>函数地址计算</h3><p>找偏移地址的时候注意，去表中找对于函数跳转，不要去某些函数内，找这个函数调用的地址，要去hook定义的部分的地址 也就是 1FA38 这个地址</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250318173557336.png" alt="image-20250318173557336"></p>
<p>地址：so基址+函数在so中的偏移[+1]</p>
<p>地址+1 是分情况的，如果是 thumb 指令需要 +1 ，如果是 arm 指令则不需要 +1。</p>
<p>在安卓中32位的so中的函数，基本都是 thumb 指令。64位的so中的函数，基本都是 arm 指令。</p>
<p>也可以通过显示汇编指令对应的 opcode bytes 来进行判断指令类型</p>
<p>选项 -&gt; 常规 -&gt; 操作码字节数(非图表) 改成 4</p>
<p>这个时候出现了四个字节的汇编指令，说明这个函数使用的 arm 指令</p>
<p>这四个字节就是 opcode bytes，就是这一条汇编对应指令的机器码</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250318175226280.png" alt="image-20250318175226280"></p>
<p>如果是两个字节，或者有两个有四个的，一般是thumb，出现四个字节一般是两个字节不够用了，将两条指令拼接在一起了，32位的只会越来越少。整不明白，可以加1和不加1都试一下呗。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libencryptlib.so&#x27;</span>)</span><br><span class="line"><span class="keyword">var</span> funcAddr = soAddr.<span class="title function_">add</span>(<span class="number">0x1FA38</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/../%E5%9B%BE%E7%89%87/image-20250318203725878.png" alt="image-20250318203725878"></p>
<p>打印出来是两个地址，但是不想直接写一个地址然后 .add 因为 Module.findBaseAddress 获取的是一个指针，直接写一个地址会报错，没有add这个方法，需要加上 ptr()</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">ptr</span>(<span class="number">0x7c9975d00</span>).<span class="title function_">add</span>(<span class="number">0x1FA38</span>))</span><br></pre></td></tr></table></figure>



<p>通过计算函数在内存中的地址，函数hook只需要一个地址，那么任意函数都可以进行hook了</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250318204103612.png" alt="image-20250318204103612"></p>
<h3 id="封装hook"><a href="#封装hook" class="headerlink" title="封装hook"></a>封装hook</h3><p>hook方法基本上就那一个，为了提高复用，封装一下函数，但是也不是一招鲜吃遍天的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">print_arg</span>(<span class="params">addr</span>) &#123;</span><br><span class="line">    <span class="comment">// 有些Java类型在这里可能出问题</span></span><br><span class="line">    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findRangeByAddress</span>(addr)</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">module</span> != <span class="literal">null</span>) <span class="keyword">return</span> <span class="title function_">hexdump</span>(addr) + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">ptr</span>(addr) + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hookFunc</span>(<span class="params">funcAddr</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(funcAddr)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(funcAddr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">logs</span> = [];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">data</span> = [];</span><br><span class="line">            <span class="comment">// 打印模块名称以及函数偏移</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">logs</span>.<span class="title function_">push</span>(<span class="string">&quot;call &quot;</span> + <span class="variable language_">module</span>.<span class="property">name</span> + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(funcAddr).<span class="title function_">sub</span>(<span class="variable language_">module</span>.<span class="property">base</span>) + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            <span class="comment">// 保存参数地址，如果作为返回值使用了这个参数，后面可以直接打印</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; args.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">data</span>.<span class="title function_">push</span>(args[i]);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">logs</span>.<span class="title function_">push</span>(<span class="string">&quot;this.args&quot;</span> + i + <span class="string">&quot;onEnter: &quot;</span> + <span class="title function_">print_arg</span>(args[i]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">logs</span>.<span class="title function_">push</span>(<span class="string">&quot;this.args&quot;</span> + i + <span class="string">&quot;onLeave: &quot;</span> + <span class="title function_">print_arg</span>(<span class="variable language_">this</span>.<span class="property">data</span>[i]));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">logs</span>.<span class="title function_">push</span>(<span class="string">&quot;return: &quot;</span> + retval);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">logs</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><div style="display: flex; justify-content: center; color: red; font-weight: 650">
    本贴仅作技术交流，如有侵权请在Github的issue联系我立即删帖
</div><br>

<h4 id="淘最热点"><a href="#淘最热点" class="headerlink" title="淘最热点"></a>淘最热点</h4><p>看下这个抓包结果 sign 四十位，盲猜是sha1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST /api/v1/auth/login/sms HTTP/1.1</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Connection: close</span><br><span class="line">Charset: UTF-8</span><br><span class="line">User-Agent: Dalvik/2.1.0 (Linux; U; Android 10; Pixel XL Build/QP1A.190711.019)</span><br><span class="line">Host: api.taozuiredian.com</span><br><span class="line">Accept-Encoding: gzip</span><br><span class="line">Content-Length: 653</span><br><span class="line"></span><br><span class="line">&#123;&quot;app_ver&quot;:&quot;100&quot;,</span><br><span class="line">&quot;sign&quot;:&quot;5d660709e3136cf8300792cde67fe9ee202718f9&quot;,</span><br><span class="line">&quot;nonce&quot;:&quot;c40vv91742382752834&quot;,</span><br><span class="line">&quot;tzrd&quot;:&quot;BwzXzSGFyiPstMIVuzTZb7LzTZzbXRJOFzpbQiIaT7t\/KDL9RCbvH\/vr0qdSE1IMBjy6D\/SQoXbTBgojGsCYv2+yA2ocToOyRo6AzjqzrJyeS1w0pRKovlZvnuEgWm\/CCVBkyWtUVaQRXVUEfMqTZ01BqKZ9AwngiYRXHEJ7tby3Yvi86oyyor6lkH8QxOqreKCsAYw44WHaqh832FsZInk+ZFv+Sja3vlS6i8QdzD5G+3Y87kHLkb6gdNw6yM606OYGoK3dHvCvWC1GT4XS3DvCETMrNSEooXKhaHKKz\/SxQ\/zoeXRRjueJoGwtyWR5mwfCJUM29iuwzpbGtMg+uNFd4Bj\/TXwePYb1Lu8huPcJDJ8ziEL4lZOAUUw+cAKAoDYF1C26RTlKPPnrxjPinliyU\/IUYhLYNtNeLJwLItZLuRJfOZbd3GvrhvfsTBt6lLLLuXh92i1BUltOcg1HTrAYYjx+dxbwTiv3EaDlVXgjtca+0Lpt2PG68\/GEAash&quot;,</span><br><span class="line">&quot;timestamp&quot;:&quot;1742382752&quot;&#125;</span><br></pre></td></tr></table></figure>



<p>tzrd使用的AES加密直接梭出来了，没有看到 SHA1，应该是在so层，从AES的堆栈进去看看</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250319191748542.png" alt="image-20250319191748542"></p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250319192311296.png" alt="image-20250319192311296"></p>
<p>传入了一个字符串，先去 libtre.so 中找sign方法吧，这里hook a函数的结果，不如留着去so层hook传入值</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250319192349922.png" alt="image-20250319192349922"></p>
<p>从导出表中找到这个方法，有三个参数</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250319192643930.png" alt="image-20250319192643930"></p>
<p>看到五个初始化常量，和SHA1的一模一样</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250319195728415.png" alt="image-20250319195728415"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">print_arg</span>(<span class="params">addr</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findRangeByAddress</span>(addr)</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">module</span> != <span class="literal">null</span>) <span class="keyword">return</span> <span class="title function_">hexdump</span>(addr) + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">ptr</span>(addr) + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hookFunc</span>(<span class="params">funcAddr, paramsNum</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(funcAddr)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(funcAddr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">logs</span> = [];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">data</span> = [];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">logs</span>.<span class="title function_">push</span>(<span class="string">&quot;call &quot;</span> + <span class="variable language_">module</span>.<span class="property">name</span> + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(funcAddr).<span class="title function_">sub</span>(<span class="variable language_">module</span>.<span class="property">base</span>) + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; paramsNum; i++) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">data</span>.<span class="title function_">push</span>(args[i]);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">logs</span>.<span class="title function_">push</span>(<span class="string">&quot;this.args&quot;</span> + i + <span class="string">&quot;  onEnter: \n&quot;</span> + <span class="title function_">print_arg</span>(args[i]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">logs</span>.<span class="title function_">push</span>(<span class="string">&quot;this.args&quot;</span> + i + <span class="string">&quot;  onLeave: \n&quot;</span> + <span class="title function_">print_arg</span>(<span class="variable language_">this</span>.<span class="property">data</span>[i]));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">logs</span>.<span class="title function_">push</span>(<span class="string">&quot;return: &quot;</span> + retval);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">logs</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> funcAddress = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&#x27;libtre.so&#x27;</span>, <span class="string">&#x27;Java_com_maihan_tredian_util_TreUtil_sign&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(funcAddress)</span><br><span class="line"><span class="title function_">hookFunc</span>(funcAddress, <span class="number">3</span>)</span><br></pre></td></tr></table></figure>



<p>有点奇怪，hook之后没有任何东西，传入的字符串也是空的，换个思路在Java层hook sign 方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">TreUtils</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.maihan.tredian.util.TreUtil&#x27;</span>)</span><br><span class="line">    <span class="title class_">TreUtils</span>.<span class="property">sign</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;TreUtils.signStr: &quot;</span> + args);</span><br><span class="line">        <span class="keyword">var</span> retval = <span class="variable language_">this</span>.<span class="title function_">sign</span>(args)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(retval)</span><br><span class="line">        <span class="keyword">return</span> retval;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>并非直接了SHA1，还进行了其他处理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">传入值：app_ver=100&amp;nonce=s5s1nx1742387030874&amp;timestamp=1742387030&amp;tzrd=BwzXzSGFyiPstMIVuzTZb7LzTZzbXRJOFzpbQiIaT7t/KDL9RCbvH/vr0qdSE1IM4+4+OnwWsQLlqfn5RxB2XC6PAW/JAMGv7TJG0yQkskekdkA25pE0vT7z4MUC5q8qEHhdCGwN67G/Qlx+hHYmGvvD/T6MpRkySeQBJJLtFIUgwBChwmTMBJgszYSJ2Oq6kO/Px0VmRW+cOmY8pxlCUir2Lt5P9frak1mJ0o2QfMC+a/yNUoJF3n1KawOb3LQHf8eIN3RsySOugxO9kqg5Cvgywtazy0I8gJQOzlTc03DleSEDXwxYRrFy7hXkHe0OuLUx+cZ5fKpIPR49uPwkxTLhQeMB1UAPeJ5mp8sV7Q/QAMeyb41dPbb2eIVxWH2D4GCF8iVi4HrEqT9UFaODOTIo75Q9Uku4bgRDr8GuFG0=</span><br><span class="line"></span><br><span class="line">返回值：868e5772a27f523020f536dc6bfbf59d3a94a8bf</span><br><span class="line"></span><br><span class="line">SHA1值：6419812ea6ff5715773fe5a2e8664fd3b43bd4a2</span><br></pre></td></tr></table></figure>



<p>v20是env，结果是v25，v25由v23拼接而来，v23由v17转换而来，v17循环取出v26的字节，v26应该是作为返回值的参数执行了 j_SHA1Result ， 既然和标准的 SHA1结果不一样，那就去这个方法中看看。之前hook没有hook出传入值是 print_arg 函数处理的问题，参数是Java类型的字符串</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250319203646060.png" alt="image-20250319203646060"></p>
<p>hook SHA1Result 方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">print_arg</span>(<span class="params">addr</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findRangeByAddress</span>(addr)</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">module</span> != <span class="literal">null</span>) <span class="keyword">return</span> <span class="title function_">hexdump</span>(addr) + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">ptr</span>(addr) + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hookFunc</span>(<span class="params">funcAddr, paramsNum</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(funcAddr)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(funcAddr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">logs</span> = [];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">data</span> = [];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">logs</span>.<span class="title function_">push</span>(<span class="string">&quot;call &quot;</span> + <span class="variable language_">module</span>.<span class="property">name</span> + <span class="string">&quot;!&quot;</span> + <span class="title function_">ptr</span>(funcAddr).<span class="title function_">sub</span>(<span class="variable language_">module</span>.<span class="property">base</span>) + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; paramsNum; i++) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">data</span>.<span class="title function_">push</span>(args[i]);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">logs</span>.<span class="title function_">push</span>(<span class="string">&quot;this.args&quot;</span> + i + <span class="string">&quot;  onEnter: \n&quot;</span> + <span class="title function_">print_arg</span>(args[i]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">logs</span>.<span class="title function_">push</span>(<span class="string">&quot;this.args&quot;</span> + i + <span class="string">&quot;  onLeave: \n&quot;</span> + <span class="title function_">print_arg</span>(<span class="variable language_">this</span>.<span class="property">data</span>[i]));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">logs</span>.<span class="title function_">push</span>(<span class="string">&quot;return: &quot;</span> + retval);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">logs</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> funcAddress = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&#x27;libtre.so&#x27;</span>, <span class="string">&#x27;SHA1Result&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(funcAddress)</span><br><span class="line"><span class="title function_">hookFunc</span>(funcAddress, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">TreUtils</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.maihan.tredian.util.TreUtil&#x27;</span>)</span><br><span class="line">    <span class="title class_">TreUtils</span>.<span class="property">sign</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;TreUtils.signStr: &quot;</span> + args);</span><br><span class="line">        <span class="keyword">var</span> retval = <span class="variable language_">this</span>.<span class="title function_">sign</span>(args)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(retval)</span><br><span class="line">        <span class="keyword">return</span> retval;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>第二个参数作为返回值和sign的返回值相同，参数1是content一个结构体，里面有五个初始化常量，还有两个参数表示明文位数</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250319210023411.png" alt="image-20250319210023411"></p>
<p>来看 SHA1Input 这里是加密函数，有三个参数第一个是content，然后就是明文以及明文长度了，hook了一下明文超长了，显示不出来，自己单独写一个，不hexdump了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&#x27;libtre.so&#x27;</span>, <span class="string">&#x27;SHA1Input&#x27;</span>), &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;SHA1Input onEnter: &quot;</span> + args[<span class="number">1</span>].<span class="title function_">readCString</span>())</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<p>这个时候将v12计算SHA1值，结果和sign的结果相同，说明明文经过处理之后变成这个的类似于base64的形式，再进行SHA1，得到和终端一样的结果</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250319212048747.png" alt="image-20250319212048747"></p>
<p>那么就需要再去往上找，看这个base64数据怎么来的了，v12在这里经过了处理，hook这个 base64函数</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250319212351692.png" alt="image-20250319212351692"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&#x27;libtre.so&#x27;</span>, <span class="string">&#x27;base64_encode_new&#x27;</span>), &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;base64_encode_new onEnter: &quot;</span> + args[<span class="number">0</span>].<span class="title function_">readCString</span>() + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;base64_encode_new onEnter: &quot;</span> + args[<span class="number">1</span>].<span class="title function_">readCString</span>() + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">args0</span> = args[<span class="number">0</span>]</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">args1</span> = args[<span class="number">1</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;base64_encode_new onLeave: &quot;</span> + <span class="variable language_">this</span>.<span class="property">args0</span>.<span class="title function_">readCString</span>() + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;base64_encode_new onEnter: &quot;</span> + <span class="variable language_">this</span>.<span class="property">args1</span>.<span class="title function_">readCString</span>() + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<p>看下sign传入值和base64的传入值的区别，只有后面多了一行东西，这个函数经过验证就是普通的base64编码，将传入的数据base64编码之后计算SHA1值，得出结果，继续往上看添加的部分内容从哪里来。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sign函数传入值：app_ver=100&amp;nonce=dzljud1742391074744&amp;timestamp=1742391074&amp;tzrd=BwzXzSGFyiPstMIVuzTZb7LzTZzbXRJOFzpbQiIaT7t/KDL9RCbvH/vr0qdSE1IM0JgX7EeFKMidFPp7uNNpzeTMNlGeAywlVhFRI1/rf3ha27vGJ7wi59YFsHm+TwWHdXfcQQznBsXajsevBoLGbvW4A2gQEj4MRhFVMJr8wZ396k/+TeAq00WbUJSnVUWbdlbNvZFYNFjVsOXdhMLbeY80y5zjpowJYYTjK8sMdDF5IyeqG+ikl7gGjFxhrWhvldlar6qKQTjBto/ZWICrdbMrqT7D0XAPTMGBGbL1Xfcb/NLIF3vd270249aTbquqP8SwrpnlYaLH+/XiDIP533YIAN38HUmVg0ke9v6t72lHqQkZNnImJ+sNeu/VmRhkr7RGrOLtOLVKGIqQNjXoXPUXYXjYUOpJqloo782X/VFeeD+cVBAiODlszxgZQWHPPQQgoXS59acrA4uEFMS3vR72cjitpNJ4auKySpDS2GjGWaFoAAHIG6Hl/5dVQCSD</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">hook出的传入值：app_ver=100&amp;nonce=dzljud1742391074744&amp;timestamp=1742391074&amp;tzrd=BwzXzSGFyiPstMIVuzTZb7LzTZzbXRJOFzpbQiIaT7t/KDL9RCbvH/vr0qdSE1IM0JgX7EeFKMidFPp7uNNpzeTMNlGeAywlVhFRI1/rf3ha27vGJ7wi59YFsHm+TwWHdXfcQQznBsXajsevBoLGbvW4A2gQEj4MRhFVMJr8wZ396k/+TeAq00WbUJSnVUWbdlbNvZFYNFjVsOXdhMLbeY80y5zjpowJYYTjK8sMdDF5IyeqG+ikl7gGjFxhrWhvldlar6qKQTjBto/ZWICrdbMrqT7D0XAPTMGBGbL1Xfcb/NLIF3vd270249aTbquqP8SwrpnlYaLH+/XiDIP533YIAN38HUmVg0ke9v6t72lHqQkZNnImJ+sNeu/VmRhkr7RGrOLtOLVKGIqQNjXoXPUXYXjYUOpJqloo782X/VFeeD+cVBAiODlszxgZQWHPPQQgoXS59acrA4uEFMS3vR72cjitpNJ4auKySpDS2GjGWaFoAAHIG6Hl/5dVQCSDb2qKgtaW4,9z9D`Fmst?K5JZbLYOY]NP6ssGf2U~;zk9oCNgoytV!&#125;wW7ia+`w9g</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">hook出的结果值：YXBwX3Zlcj0xMDAmbm9uY2U9ZHpsanVkMTc0MjM5MTA3NDc0NCZ0aW1lc3RhbXA9MTc0MjM5MTA3NCZ0enJkPUJ3elh6U0dGeWlQc3RNSVZ1elRaYjdMelRaemJYUkpPRnpwYlFpSWFUN3QvS0RMOVJDYnZIL3ZyMHFkU0UxSU0wSmdYN0VlRktNaWRGUHA3dU5OcHplVE1ObEdlQXl3bFZoRlJJMS9yZjNoYTI3dkdKN3dpNTlZRnNIbStUd1dIZFhmY1FRem5Cc1hhanNldkJvTEdidlc0QTJnUUVqNE1SaEZWTUpyOHdaMzk2ay8rVGVBcTAwV2JVSlNuVlVXYmRsYk52WkZZTkZqVnNPWGRoTUxiZVk4MHk1empwb3dKWVlUaks4c01kREY1SXllcUcraWtsN2dHakZ4aHJXaHZsZGxhcjZxS1FUakJ0by9aV0lDcmRiTXJxVDdEMFhBUFRNR0JHYkwxWGZjYi9OTElGM3ZkMjcwMjQ5YVRicXVxUDhTd3JwbmxZYUxIKy9YaURJUDUzM1lJQU4zOEhVbVZnMGtlOXY2dDcybEhxUWtaTm5JbUorc05ldS9WbVJoa3I3UkdyT0x0T0xWS0dJcVFOalhvWFBVWFlYallVT3BKcWxvbzc4MlgvVkZlZUQrY1ZCQWlPRGxzenhnWlFXSFBQUVFnb1hTNTlhY3JBNHVFRk1TM3ZSNzJjaml0cE5KNGF1S3lTcERTMkdqR1dhRm9BQUhJRzZIbC81ZFZRQ1NEYjJxS2d0YVc0LDl6OURgRm1zdD9LNUpaYkxZT1ldTlA2c3NHZjJVfjt6azlvQ05nb3l0ViF9d1c3aWErYHc5Zw==</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3078a71b38656dac7f798e5ed91370a4e05b15a8</span><br></pre></td></tr></table></figure>



<p>一眼顶针，破案了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b2qKgtaW4,9z9D`Fmst?K5JZbLYOY]NP6ssGf2U~;zk9oCNgoytV!&#125;wW7ia+`w9g</span><br></pre></td></tr></table></figure>

<p><img src="/../%E5%9B%BE%E7%89%87/image-20250319213927557.png" alt="image-20250319213927557"></p>
<h4 id="马蜂窝"><a href="#马蜂窝" class="headerlink" title="马蜂窝"></a>马蜂窝</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">POST /rest/app/user/login/ HTTP/1.1</span><br><span class="line">User-Agent: Dalvik/2.1.0 (Linux; U; Android 10; Pixel XL Build/QP1A.190711.019) mfwappcode/com.mfw.roadbook mfwappver/8.1.6 mfwversioncode/535 mfwsdk/20140507 channel/GROWTH-WAP-LC-3 mfwjssdk/1.1 mfwappjsapi/1.5</span><br><span class="line">Connection: close</span><br><span class="line">X-HTTP-METHOD-OVERRIDE: PUT</span><br><span class="line">Content-Type: application/x-www-form-urlencoded; charset=UTF-8</span><br><span class="line">Host: mapi.mafengwo.cn</span><br><span class="line">Accept-Encoding: gzip</span><br><span class="line">Cookie: __openudid=40:4E:36:1F:FF:FA; PHPSESSID=kn4g46rulhlngld4hh1kt22st3; mfw_uuid=67da9c03-cce6-c4b3-cafb-bea1c5e1f15e; oad_n=a%3A3%3A%7Bs%3A3%3A%22oid%22%3Bi%3A1029%3Bs%3A2%3A%22dm%22%3Bs%3A16%3A%22mapi.mafengwo.cn%22%3Bs%3A2%3A%22ft%22%3Bs%3A19%3A%222025-03-19+18%3A27%3A15%22%3B%7D</span><br><span class="line">Content-Length: 668</span><br><span class="line"></span><br><span class="line">x_auth_username=13112345678</span><br><span class="line">&amp;o_lat=36.651429</span><br><span class="line">&amp;device_type=android</span><br><span class="line">&amp;oauth_version=1.0</span><br><span class="line">&amp;oauth_signature_method=HMAC-SHA1</span><br><span class="line">&amp;screen_height=2392</span><br><span class="line">&amp;open_udid=40%3A4E%3A36%3A1F%3AFF%3AFA</span><br><span class="line">&amp;put_style=default</span><br><span class="line">&amp;app_version_code=535</span><br><span class="line">&amp;x_auth_mode=client_auth</span><br><span class="line">&amp;sys_ver=10</span><br><span class="line">&amp;o_lng=117.530121</span><br><span class="line">&amp;brand=google</span><br><span class="line">&amp;app_code=com.mfw.roadbook</span><br><span class="line">&amp;screen_scale=3.5</span><br><span class="line">&amp;screen_width=1440</span><br><span class="line">&amp;time_offset=480</span><br><span class="line">&amp;device_id=40%3A4E%3A36%3A1F%3AFF%3AFA</span><br><span class="line">&amp;oauth_signature=XVbVjoMGaGvmLS%2FKFS9WfYuiEL8%3D</span><br><span class="line">&amp;x_auth_password=132465879</span><br><span class="line">&amp;oauth_consumer_key=5</span><br><span class="line">&amp;oauth_timestamp=1742380119</span><br><span class="line">&amp;oauth_nonce=b2de4730-cc2a-486a-846e-11241d0cc79d</span><br><span class="line">&amp;mfwsdk_ver=20140507</span><br><span class="line">&amp;app_ver=8.1.6</span><br><span class="line">&amp;hardware_model=Pixel+XL</span><br><span class="line">&amp;channel_id=GROWTH-WAP-LC-3</span><br><span class="line">&amp;after_style=default&amp;</span><br></pre></td></tr></table></figure>



<p>这个 oauth_signture 看起来像是加密之后的东西，hook一下加密算法，有一个请求上面包含了username</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250320184541264.png" alt="image-20250320184541264"></p>
<p>找到了这个 oauth_signture hook这个函数直接</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250320185454584.png" alt="image-20250320185454584"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">LoginRequestModel</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.mfw.uniloginsdk.rest.LoginRequestModel&quot;</span>);</span><br><span class="line">    <span class="title class_">LoginRequestModel</span>[<span class="string">&quot;getParams&quot;</span>].<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`LoginRequestModel.getParams is called`</span>);</span><br><span class="line">        <span class="keyword">let</span> result = <span class="variable language_">this</span>[<span class="string">&quot;getParams&quot;</span>]();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 因为是Map类型，直接打印只有 [object, object] 需要调用 toString 方法，但是 Map接口没有这个方法，需要使用他的子类 HashMap</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> a = <span class="title class_">Java</span>.<span class="title function_">cast</span>(result, <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.util.HashMap&quot;</span>));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`LoginRequestModel.getParams result=<span class="subst">$&#123;a.toString()&#125;</span>`</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(e)   </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 结果</span></span><br><span class="line">result=&#123;x_auth_username=<span class="number">19386737821</span>, o_lat=<span class="number">36.651534</span>, device_type=android, oauth_version=<span class="number">1.0</span>, oauth_signature_method=<span class="variable constant_">HMAC</span>-<span class="title class_">SHA1</span>, screen_height=<span class="number">2392</span>, open_udid=<span class="number">40</span>:4<span class="attr">E</span>:<span class="number">36</span>:1<span class="attr">F</span>:<span class="attr">FF</span>:<span class="variable constant_">FA</span>, put_style=<span class="keyword">default</span>, app_version_code=<span class="number">535</span>, x_auth_mode=client_auth, sys_ver=<span class="number">10</span>, o_lng=<span class="number">117.529731</span>, brand=google, app_code=com.<span class="property">mfw</span>.<span class="property">roadbook</span>, screen_scale=<span class="number">3.5</span>, screen_width=<span class="number">1440</span>, time_offset=<span class="number">480</span>, device_id=<span class="number">40</span>:4<span class="attr">E</span>:<span class="number">36</span>:1<span class="attr">F</span>:<span class="attr">FF</span>:<span class="variable constant_">FA</span>, </span><br><span class="line">oauth_signature=xxTbfIYa5irlipggblueouaKB3k=,</span><br><span class="line">x_auth_password=dghiutrrp07, oauth_consumer_key=<span class="number">5</span>, oauth_timestamp=<span class="number">1742468520</span>, oauth_nonce=afc3c969-b626-44bd-9bcb-8e0936cd5d48, mfwsdk_ver=<span class="number">20140507</span>, app_ver=<span class="number">8.1</span><span class="number">.6</span>, hardware_model=<span class="title class_">Pixel</span> <span class="variable constant_">XL</span>, channel_id=<span class="variable constant_">GROWTH</span>-<span class="variable constant_">WAP</span>-<span class="variable constant_">LC</span>-<span class="number">3</span>, after_style=<span class="keyword">default</span>&#125;</span><br></pre></td></tr></table></figure>



<p>貌似hook多余了，进去分析吧</p>
<p>曲里拐弯的到这个 cryptoParams 这里面，传入四个参数，之前添加的数组就是其中一个参数，红线表示方法执行方向，蓝线表示传入的数据。</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250320191238238.png" alt="image-20250320191238238"></p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250320191502608.png" alt="image-20250320191502608"></p>
<p>这里就可以看到已经进入so层的，分析之前前将 source 的内容hook一下，在进这个方法前执行了一个方法，将数据变成了一个字符串，不用管直接hook看看内容，再进so</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">SecurityTools</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.mfw.uniloginsdk.util.SecurityTools&quot;</span>);</span><br><span class="line">    <span class="title class_">SecurityTools</span>[<span class="string">&quot;encodePramas&quot;</span>].<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">method, baseUri, params</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> a = <span class="title class_">Java</span>.<span class="title function_">cast</span>(params, <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.util.HashMap&quot;</span>))</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`SecurityTools.encodePramas is called: method=<span class="subst">$&#123;method&#125;</span>, baseUri=<span class="subst">$&#123;baseUri&#125;</span>, params=<span class="subst">$&#123;a.toString()&#125;</span>`</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(error)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> result = <span class="variable language_">this</span>[<span class="string">&quot;encodePramas&quot;</span>](method, baseUri, params);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`SecurityTools.encodePramas result=<span class="subst">$&#123;result&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>





<p>看结果是将三部分拼接在一起，然后进url编码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">参数：</span><br><span class="line">method=PUT, </span><br><span class="line">baseUri=https://mapi.mafengwo.cn/rest/app/user/login/, </span><br><span class="line">params=&#123;x_auth_username=19386737821, o_lat=36.651534, device_type=android, oauth_version=1.0, oauth_signature_method=HMAC-SHA1, screen_height=2392, open_udid=40:4E:36:1F:FF:FA, put_style=default, app_version_code=535, x_auth_mode=client_auth, sys_ver=10, o_lng=117.529731, brand=google, app_code=com.mfw.roadbook, screen_scale=3.5, screen_width=1440, time_offset=480, device_id=40:4E:36:1F:FF:FA, x_auth_password=dghiutrrp07, oauth_consumer_key=5, oauth_timestamp=1742469539, oauth_nonce=9951eaa6-af5c-43d2-bd3d-9a3271e31a23, mfwsdk_ver=20140507, app_ver=8.1.6, hardware_model=Pixel XL, channel_id=GROWTH-WAP-LC-3, after_style=default&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">返回值：</span><br><span class="line">result=PUT&amp;https%3A%2F%2Fmapi.mafengwo.cn%2Frest%2Fapp%2Fuser%2Flogin%2F&amp;after_style%3Ddefault%26app_code%3Dcom.mfw.roadbook%26app_ver%3D8.1.6%26app_version_code%3D535%26brand%3Dgoogle%26channel_id%3DGROWTH-WAP-LC-3%26device_id%3D40%253A4E%253A36%253A1F%253AFF%253AFA%26device_type%3Dandroid%26hardware_model%3DPixel%2520XL%26mfwsdk_ver%3D20140507%26o_lat%3D36.651534%26o_lng%3D117.529731%26oauth_consumer_key%3D5%26oauth_nonce%3D9951eaa6-af5c-43d2-bd3d-9a3271e31a23%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1742469539%26oauth_version%3D1.0%26open_udid%3D40%253A4E%253A36%253A1F%253AFF%253AFA%26put_style%3Ddefault%26screen_height%3D2392%26screen_scale%3D3.5%26screen_width%3D1440%26sys_ver%3D10%26time_offset%3D480%26x_auth_mode%3Dclient_auth%26x_auth_password%3Ddghiutrrp07%26x_auth_username%3D19386737821</span><br></pre></td></tr></table></figure>



<p>根据这个返回值写一个主动调用方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">call_java</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Authori</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.mfw.tnative.AuthorizeHelper&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> data = <span class="string">&quot;PUT&amp;https%3A%2F%2Fmapi.mafengwo.cn%2Frest%2Fapp%2Fuser%2Flogin%2F&amp;after_style%3Ddefault%26app_code%3Dcom.mfw.roadbook%26app_ver%3D8.1.6%26app_version_code%3D535%26brand%3Dgoogle%26channel_id%3DGROWTH-WAP-LC-3%26device_id%3D40%253A4E%253A36%253A1F%253AFF%253AFA%26device_type%3Dandroid%26hardware_model%3DPixel%2520XL%26mfwsdk_ver%3D20140507%26o_lat%3D36.651534%26o_lng%3D117.529731%26oauth_consumer_key%3D5%26oauth_nonce%3Dc04dd3a1-dbaf-483f-8534-eb3a578d95ab%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1742469964%26oauth_version%3D1.0%26open_udid%3D40%253A4E%253A36%253A1F%253AFF%253AFA%26put_style%3Ddefault%26screen_height%3D2392%26screen_scale%3D3.5%26screen_width%3D1440%26sys_ver%3D10%26time_offset%3D480%26x_auth_mode%3Dclient_auth%26x_auth_password%3Ddghiutrrp07%26x_auth_username%3D19386737821&quot;</span></span><br><span class="line">        <span class="keyword">var</span> current_application = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;android.app.ActivityThread&#x27;</span>).<span class="title function_">currentApplication</span>();</span><br><span class="line">        <span class="keyword">var</span> cpntext = current_application.<span class="title function_">getApplicationContext</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 需要new一个对象，而且有构造函数，需要传入一个字符串，代码中这个传入的字符串是&quot;com.mfw.roadbook&quot;</span></span><br><span class="line">        <span class="keyword">var</span> result = <span class="title class_">Authori</span>.$new(<span class="string">&quot;com.mfw.roadbook&quot;</span>).<span class="title function_">xAuthencode</span>(cpntext, data, <span class="string">&quot;&quot;</span>, <span class="string">&quot;com.mfw.roadbook&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(result);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>so层传了五个参数，第一个是一个context，第二个是url编码后的数据，第三个是 “” 第四个传入的是true</p>
<p>第二个参数在so中是 a4 这个结果就是将 jstring 数据类型转换成c语言中的字符串，然后压如SHA1计算，计算结果转换成 base64 ，再转换成Java类型字符串返回出去</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250320194425926.png" alt="image-20250320194425926"></p>
<p>先hook一下这个base64方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hook base64_encode</span></span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&#x27;libmfw.so&#x27;</span>, <span class="string">&#x27;_ZN3mfw6Base6413base64_encodeEPKci&#x27;</span>), &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;base64_encode_new onEnter: &quot;</span> + <span class="title function_">hexdump</span>(args[<span class="number">1</span>]) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;base64_encode_new onLeave: &quot;</span> + <span class="title function_">hexdump</span>(retval) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>





<p>上面疑似是SHA1，取40位十六进制数，进行hex to base64编解码，结果和正常运行相同</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250322192251632.png" alt="image-20250322192251632"></p>
<p>这个base64方法就是一个简单的 hex to base64方法，继续向上，hook update方法，看到是直接传入的原文没问题。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hook Sha1 final</span></span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&#x27;libmfw.so&#x27;</span>, <span class="string">&#x27;_ZN3mfw4Sha15CHmac6UpdateEPKhj&#x27;</span>), &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Sha1 final onEnter: &quot;</span> + <span class="title function_">hexdump</span>(args[<span class="number">0</span>]) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Sha1 final onEnter: &quot;</span> + args[<span class="number">1</span>].<span class="title function_">readCString</span>() + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">arg1</span> = args[<span class="number">0</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Sha1 final onLeave: &quot;</span> + <span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg1</span>) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Sha1 final onLeave: &quot;</span> + retval + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<p><img src="/../%E5%9B%BE%E7%89%87/image-20250322194011120.png" alt="image-20250322194011120"></p>
<p>可以注意到的是，方法名是 sha1:chmac 什么的，这个是一个基于密钥的信息摘要算法，还有一个setkey方法来设置密钥，hook这个方法，分析一下第三个参数应该是密钥长度</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&#x27;libmfw.so&#x27;</span>, <span class="string">&#x27;_ZN3mfw4Sha15CHmac6SetKeyEPKhj&#x27;</span>), &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;setkey onEnter: &quot;</span> + <span class="title function_">hexdump</span>(args[<span class="number">0</span>]) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;setkey onEnter: &quot;</span> + <span class="title function_">hexdump</span>(args[<span class="number">1</span>]) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;setkey onEnter: &quot;</span> + args[<span class="number">2</span>] + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">arg1</span> = args[<span class="number">0</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;setkey onLeave: &quot;</span> + <span class="title function_">hexdump</span>(<span class="variable language_">this</span>.<span class="property">arg1</span>) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;setkey onLeave: &quot;</span> + retval + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<p>长度33位</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250322201329904.png" alt="image-20250322201329904"></p>
<p>拿过来去 hamc-sha1 运算一下，标准结果</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250322201233593.png" alt="image-20250322201233593"></p>
<h4 id="过简单root检测（海博TV）"><a href="#过简单root检测（海博TV）" class="headerlink" title="过简单root检测（海博TV）"></a>过简单root检测（海博TV）</h4><p><img src="/../%E5%9B%BE%E7%89%87/image-20250322202602752.png" alt="image-20250322202602752"></p>
<p>拿这个字符串爆搜一下，找到了相关代码</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250322203339145.png" alt="image-20250322203339145"></p>
<p>hook掉run函数，或者让   systemUtils.checkSuDile() 返回false，让 SystemUtils.checkRootFile() &#x3D;&#x3D; null</p>
<p>两种方法均可，第二种稳重有点，自写的检测root方法hook掉了，也能防止其他地方再进行调用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 不执行run方法，直接return</span></span><br><span class="line">    <span class="comment">// let AnonymousClass1 = Java.use(&quot;com.hoge.android.factory.welcome.WelcomeActivity$2$1&quot;);</span></span><br><span class="line">    <span class="comment">// AnonymousClass1[&quot;run&quot;].implementation = function () &#123;</span></span><br><span class="line">    <span class="comment">//     console.log(`AnonymousClass1.run is called`);</span></span><br><span class="line">    <span class="comment">//     return;</span></span><br><span class="line">    <span class="comment">// &#125;;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 令checkSuFile方法返回false</span></span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">SystemUtils</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.hoge.android.factory.util.system.SystemUtils&quot;</span>);</span><br><span class="line">    <span class="title class_">SystemUtils</span>[<span class="string">&quot;checkSuFile&quot;</span>].<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`SystemUtils.checkSuFile is called`</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 令checkRootFile方法返回null</span></span><br><span class="line">    <span class="title class_">SystemUtils</span>[<span class="string">&quot;checkRootFile&quot;</span>].<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`RootUtils.checkRootFile is called`</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><img src="/../%E5%9B%BE%E7%89%87/image-20250322210037646.png" alt="image-20250322210037646"></p>
<p>以上纯属我静态玩习惯了，这个提示可以hook一下toast的show方法试试，找到堆栈后再进行操作</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> toast = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.widget.Toast&quot;</span>)</span><br><span class="line">toast.<span class="property">show</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">	<span class="title function_">showStack</span>()</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;toast.show: &#x27;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">show</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在Java层检测root一般有两种方式，一种是检测 su 文件，另一种是执行 su 命令</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250322212112068.png" alt="image-20250322212112068"></p>
<p>搬运一个检测检测root的脚本，通过检测是否在检测su文件和执行su命令，再打印堆栈，快速定位。</p>
<p>上方的代码就是使用了 java.io.File 中的检测su文件的方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">showStacks</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">            <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.util.Log&quot;</span>)</span><br><span class="line">                .<span class="title function_">getStackTraceString</span>(</span><br><span class="line">                    <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Throwable&quot;</span>).$new()</span><br><span class="line">                )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.io.File&quot;</span>).<span class="property">$init</span>.<span class="title function_">overload</span>(<span class="string">&quot;java.lang.String&quot;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">str</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (str.<span class="title function_">toLowerCase</span>().<span class="title function_">endsWith</span>(<span class="string">&quot;/su&quot;</span>) || str.<span class="title function_">toLowerCase</span>() == <span class="string">&quot;su&quot;</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;发现检测su文件&quot;</span>);</span><br><span class="line">            <span class="title function_">showStacks</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.$init(str);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Runtime&quot;</span>).<span class="property">exec</span>.<span class="title function_">overload</span>(<span class="string">&quot;java.lang.String&quot;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">str</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (str.<span class="title function_">endsWith</span>(<span class="string">&quot;/su&quot;</span>) || str == <span class="string">&quot;su&quot;</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;发现尝试执行su命令的行为&quot;</span>);</span><br><span class="line">            <span class="title function_">showStacks</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">exec</span>(str);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Runtime&quot;</span>).<span class="property">exec</span>.<span class="title function_">overload</span>(<span class="string">&quot;[Ljava.lang.String;&quot;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">stringArray</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; stringArray.<span class="property">length</span>; i++)&#123;</span><br><span class="line">            <span class="keyword">if</span> (stringArray[i].<span class="title function_">includes</span>(<span class="string">&quot;su&quot;</span>) || stringArray[i].<span class="title function_">includes</span>(<span class="string">&quot;/su&quot;</span>) || stringArray[i] == <span class="string">&quot;su&quot;</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;发现尝试执行su命令的行为&quot;</span>);</span><br><span class="line">                <span class="title function_">showStacks</span>();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">exec</span>(stringArray);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>).<span class="property">$init</span>.<span class="title function_">overload</span>(<span class="string">&quot;[Ljava.lang.String;&quot;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">stringArray</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>;i &lt; stringArray.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (stringArray[i].<span class="title function_">includes</span>(<span class="string">&quot;su&quot;</span>) || stringArray[i].<span class="title function_">includes</span>(<span class="string">&quot;/su&quot;</span>) || stringArray[i] == <span class="string">&quot;su&quot;</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;发现尝试执行su命令的行为&quot;</span>);</span><br><span class="line">                <span class="title function_">showStacks</span>();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.$init(stringArray);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<p>回归主线任务，抓个包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST /api/v1/m_login.php?app_version=4.0.0&amp;latitude=36.6571&amp;phone_models=PixelXL&amp;client_id_android=8e1eb7aa6447bd52a7610367efe3743f&amp;language=Chinese&amp;client_type=android&amp;version=4.0.0&amp;locating_city=%E6%B5%8E%E5%8D%97%E5%B8%82&amp;system_version=10&amp;appid=9&amp;device_token=e594f4c3a2ee38fbece4cb9bc0d25db1&amp;location_city=%E6%B5%8E%E5%8D%97&amp;package_name=com.hoge.android.app.fujian&amp;appkey=OU4VuJgmGkqFzelCaueFLHll1sZJpOG4&amp;longitude=117.536288 HTTP/1.1</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8</span><br><span class="line">User-Agent: Dalvik/2.1.0 (Linux; U; Android 10; Pixel XL Build/QP1A.190711.019) m2oSmartCity_468 1.0.0</span><br><span class="line">X-API-VERSION: 4.0.0</span><br><span class="line">X-API-SIGNATURE: N2ZmYmI1NDg2MDIwZWY4MDg1NzllMGJhMDhiMmVjYjkwZGE1N2I4Ng==</span><br><span class="line">X-API-KEY: 877a9ba7a98f75b90a9d49f53f15a858</span><br><span class="line">X-API-TIMESTAMP: 17426501216701KEgjq</span><br><span class="line">X-AUTH-TYPE: sha1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 93</span><br><span class="line">Host: mapi-plus.fjtv.net</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line">Accept-Encoding: gzip</span><br><span class="line"></span><br><span class="line">password=123456789&amp;client_id_android=8e1eb7aa6447bd52a7610367efe3743f&amp;member_name=13112345678</span><br></pre></td></tr></table></figure>





<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">看名字就知道是密文</span><br><span class="line">X-API-SIGNATURE: N2ZmYmI1NDg2MDIwZWY4MDg1NzllMGJhMDhiMmVjYjkwZGE1N2I4Ng==</span><br></pre></td></tr></table></figure>





<p>看方法名应该是一个SHA1加密，结合上文base64解密之后得到40位十六进制数，基本可以确定，hook算法一看全是md5，sha1应该在so层了</p>
<p>顺着md5堆栈进去看看</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250326191154833.png" alt="image-20250326191154833"></p>
<p>没找到，hook一下hashmap，打印 x-api的堆栈</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">showStacks</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">            <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.util.Log&quot;</span>)</span><br><span class="line">               .<span class="title function_">getStackTraceString</span>(</span><br><span class="line">                    <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.Throwable&quot;</span>).$new()</span><br><span class="line">                )</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// hook HashMap.put方法</span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">HashMap</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.util.HashMap&#x27;</span>);</span><br><span class="line">    <span class="title class_">HashMap</span>.<span class="property">put</span>.<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">a, b</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (a.<span class="title function_">equals</span>(<span class="string">&quot;X-API-SIGNATURE&quot;</span>)) &#123;</span><br><span class="line">            <span class="title function_">showStacks</span>();</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;hashMap.put :&quot;</span>, a, b);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;put: &quot;</span>, a, b);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">put</span>(a, b);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<p><img src="/../%E5%9B%BE%E7%89%87/image-20250326192113496.png" alt="image-20250326192113496"></p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250326200345200.png" alt="image-20250326200345200"></p>
<p>使用了反射，获取<code>com.hoge.android.jni.Utils</code> 这个类，调用了下面的 verify 方法，下面是base64编码</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250326201535820.png" alt="image-20250326201535820"></p>
<p>分别调用了 verify 和 signature 两个方法，进so</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250326201805424.png" alt="image-20250326201805424"></p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250326202743143.png" alt="image-20250326202743143"></p>
<p>传入sha1_encode方法的值是由固定值+版本号+时间戳拼接出来的，第二个参数表示第一个参数的长度，不管</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250326204709972.png" alt="image-20250326204709972"></p>
<p>试一下就可以得出密文，和主动调用方法的返回值相同</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250326205159753.png" alt="image-20250326205159753"></p>
<p>但是和sh1_code返回的不同，看看后面进行了什么操作</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250326205234734.png" alt="image-20250326205234734"></p>
<p>传进来的p是一个二级指针，还需要进行一个dump操作</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250326205818222.png" alt="image-20250326205818222"></p>
<h5 id="二级指针"><a href="#二级指针" class="headerlink" title="二级指针"></a>二级指针</h5><p>对于二级指针dump完毕之后再read一下，就可以得到最终结果</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250326210108258.png" alt="image-20250326210108258"></p>
<h4 id="喜马拉雅（jnitrace）"><a href="#喜马拉雅（jnitrace）" class="headerlink" title="喜马拉雅（jnitrace）"></a>喜马拉雅（jnitrace）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">POST /mobile/login/pwd/v3 HTTP/1.1</span><br><span class="line">Cookie: 1&amp;_device=android&amp;56b0117a-f35a-3ef9-a446-f7bc8106b073&amp;6.6.99;</span><br><span class="line">channel=and-f5;</span><br><span class="line">impl=com.ximalaya.ting.android;</span><br><span class="line">osversion=29;</span><br><span class="line">fp=009527657x2022q22564v0500000000000000000000000000000000000000;</span><br><span class="line">device_model=Pixel+XL;</span><br><span class="line">XUM=QE42H//6;</span><br><span class="line">XIM=;</span><br><span class="line">c-oper=%E6%9C%AA%E7%9F%A5;</span><br><span class="line">net-mode=WIFI;</span><br><span class="line">freeFlowType=0;</span><br><span class="line">res=1440%2C2392;</span><br><span class="line">NSUP=;</span><br><span class="line">AID=MIUzwY58O3A=;</span><br><span class="line">manufacturer=Google;</span><br><span class="line">XD=vSynL63b/8L6A1owosXQAEGW6RvWQoLw/TQOroqGMWk+nzIYa/r4LmaYTBIWpO3jcF3hAT+pHBGeYLYEUF+Dv/AMzoGQ6FnuQLpf0J4nUziKa0h9dV/eaAz7/vpklecYwEWcd7mmZIGMWLJRdW781Q==;</span><br><span class="line">umid=ai3f952a188260a7f741a05185654a2f35;</span><br><span class="line">xm_grade=0;</span><br><span class="line">minorProtectionStatus=0;</span><br><span class="line">domain=.ximalaya.com;</span><br><span class="line">path=/;</span><br><span class="line">Cookie2: $version=1</span><br><span class="line">Accept: */*</span><br><span class="line">user-agent: ting_6.6.99(Pixel+XL,Android29)</span><br><span class="line">Content-Type: application/json; charset=utf-8</span><br><span class="line">Content-Length: 555</span><br><span class="line">Host: passport.ximalaya.com</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line">Accept-Encoding: gzip</span><br><span class="line"></span><br><span class="line">&#123;&quot;password&quot;:&quot;WPx31AvNzAvMp68QxTeJpc0eIqM+FJ1EAhoD2zqvu7kl9uer9++Gir90u40LLLrLVqMbqVNu2Rwa\nmdBbwHo1g09pGIKi6+4e4to+rruVisM+nG6MsaKzFSOSivcYcAIQWWHr46LDz4RyrhXRT5Sfyg3A\n7ZkzJ0nGacHT3wszpkM\u003d\n&quot;,</span><br><span class="line">&quot;fdsOtp&quot;:&quot;5984527305712495266&quot;,</span><br><span class="line">&quot;signature&quot;:&quot;3f9dac222d8aa8aa3fb24f20550195b6da6c89b8&quot;,</span><br><span class="line">&quot;nonce&quot;:&quot;0-D127A1F78429163784d3cafa706f7c3c7581deb0c963482b9528b37ca091f7&quot;,</span><br><span class="line">&quot;account&quot;:&quot;aVI9JVHbk7R5gShGpeR0TQOOat8Y7au93nezmiQWXJrW318z+z0laHFgCxjjkGR5FF70OYtT81D9\nOJOTNVmTidroFXb0+x7yDJdqeBI0/9lGcORyz21a39lv1a+CS3T9CNy+E5U9IMEQBcYAH1MdtvoZ\nm89MsO+7T3fy9To81BU\u003d\n&quot;&#125;</span><br></pre></td></tr></table></figure>



<p>password和account使用的RSA加密，signature使用的SHA1摘要</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250328085949170.png" alt="image-20250328085949170"></p>
<p>顺着堆栈进来，这个比上个好找多了，进so</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250328090712978.png" alt="image-20250328090712978"></p>
<p>先hook一下Java层的native方法，获取输出，根据输出构建一个主动调用，先看SHA1吧，RSA没法固定，因为是pkcs随机填充，即使明文相同加密结果也不同</p>
<p>成功固定SHA1的值</p>
<p>注意换行符不要取消掉，换行符也会被处理成base64或者hex的形式参与运算，SHA1的结果改变了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">call_java_rsa</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// 获取context</span></span><br><span class="line">        <span class="keyword">var</span> current_application = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;android.app.ActivityThread&#x27;</span>).<span class="title function_">currentApplication</span>();</span><br><span class="line">        <span class="keyword">var</span> context = current_application.<span class="title function_">getApplicationContext</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="title class_">LoginEncryptUtil</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.ximalaya.ting.android.loginservice.LoginEncryptUtil&quot;</span>);</span><br><span class="line">        <span class="keyword">let</span> res = <span class="title class_">LoginEncryptUtil</span>.$new().<span class="title class_">AQqfJzIZgx</span>(context, <span class="literal">false</span>, <span class="string">`account=IzhO9KzTZEaefWPEqFnDbeEhlH+du6o5uL25XphTC58lYPavTozEtGck9sO//RsOjxJs7tttBoee</span></span><br><span class="line"><span class="string">o0WqWFmdhvLBCgbD1nlMisS7RQWDvLaxLwTZ0qNnl0o3sucgPutB5C2ha2JeXiZ5bSsqC/mBImIc</span></span><br><span class="line"><span class="string">63o/0a+N0jj8wBYlMZM=</span></span><br><span class="line"><span class="string">&amp;fdsOtp=8146851191835527943&amp;nonce=0-C28C2BB39498353157107a7aefdbd9fde44e9488a6c16f12e019d7809537d3&amp;password=HH/flt6sLjwF4pOg1dSD5Re4/2yBMvDqkhz5m4ZQ3msZ65gAff79PXkTjRjbVNMATKNlcKekwG9I</span></span><br><span class="line"><span class="string">zPyHGsy1fr0uExhdpu8ilD66hrzJmnpcV1xlEDUiWE+l820OpAz5EXrpaRHef6VWxcTSIcxADjLL</span></span><br><span class="line"><span class="string">lpCsG4xYcSahB2rVDc8=</span></span><br><span class="line"><span class="string">&amp;`</span>)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;res:&quot;</span>, res)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// RSA密钥</span></span><br><span class="line"><span class="title class_">MIGfMA</span>0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCVhaR3Or7suUlwHUl2Ly36uVmboZ3+<span class="title class_">HhovogDjLgRE9CbaUokS2</span>eqGaVFfbxAUxFThNDuXq/fBD+<span class="title class_">SdUgppmcZrIw4HMMP4AtE2</span>qJJQH/<span class="title class_">KxPWmbXH7Lv</span>+9CisNtPYOlvWJ/<span class="title class_">GHRqf9</span>x3TBKjjeJ2CjuVxlPBDX63+<span class="title class_">Ecil2JR9</span>klVawIDAQAB</span><br></pre></td></tr></table></figure>

<p><img src="/../%E5%9B%BE%E7%89%87/image-20250328093112872.png" alt="image-20250328093112872"></p>
<p>这个so是进行过混淆的，不能之间点击函数名来进行跳转查看字符串的信息，而且代码十分的抽象，十分的不想看，这个时候就需要hook这个字符串地址了</p>
<h5 id="jnitrace"><a href="#jnitrace" class="headerlink" title="jnitrace"></a>jnitrace</h5><p>可以使用大佬写好的工具 jnitrace，先下载安装，注意看要求的frida版本，GitHub：<a target="_blank" rel="noopener" href="https://github.com/chame1eon/jnitrace">https://github.com/chame1eon/jnitrace</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip install jnitrace</span><br><span class="line"></span><br><span class="line">// 还有一些其他配置，比如frida hexdump 等库，之前配置frida的时候都安装好了</span><br></pre></td></tr></table></figure>



<p>使用方式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">jnitrace -l [so名] [包名]</span><br><span class="line">// jnitrace是支持hook多个so文件的使用 -l [so] -l [so] 或者 -l *</span><br><span class="line">// 这种方式是进行重启的相当于 -U -l -f。如果要hook的so文件执行很多的话，可能导致app崩溃或者软件一直处于加载状态，直到全部信息输出完毕</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-m &lt;spawn|attach&gt;</span><br><span class="line">// 有两个值，分别是 spawn、attach。spawn是生成，attach是附着，一般使用attach，相当于 -F</span><br><span class="line"></span><br><span class="line">-o path/output.json</span><br><span class="line">// 将结果输出成json格式</span><br><span class="line"></span><br><span class="line">-p path/script.js</span><br><span class="line">// jnitrace执行前先注入frida脚本</span><br><span class="line"></span><br><span class="line">-i [函数名]</span><br><span class="line">// 仅追踪特定的函数</span><br></pre></td></tr></table></figure>



<p>这个东西比较玄学，我碰到了三报错，忙活了一天也没解决</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250328213852049.png" alt="image-20250328213852049"></p>
<h5 id="ollvm字符串解密"><a href="#ollvm字符串解密" class="headerlink" title="ollvm字符串解密"></a>ollvm字符串解密</h5><p>对于这种加密了的，看不见明文的可以根据地址值dump一下</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250329144646183.png" alt="image-20250329144646183"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;liblogin_encrypt.so&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(soAddr.<span class="title function_">add</span>(<span class="string">&#x27;0xD060&#x27;</span>)))</span><br></pre></td></tr></table></figure>

<p>可能会报的错误： <code>TypeError: cannot read property &#39;add&#39; of null</code> 这个就是so未加载，以这个案例为例，登录一次之后就会加载，这个错误就不存在了</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250329144835438.png" alt="image-20250329144835438"></p>
<p>这个两个加密的字符串分别是 RSA 和 java&#x2F;security&#x2F;KeyFactory ，先获取java&#x2F;security&#x2F;KeyFactory类，后面的点不是了 00 就代表字符串结尾了 getInstance 是 getstaticMethodId 里的内容，去获取了这个方法，然后方法名后面是方法签名 (Ljava&#x2F;lang&#x2F;String;)Ljava&#x2F;security&#x2F;KeyFactory，传入字符串返回一个Java类，看起来是一个构造方法</p>
<h5 id="so-dump"><a href="#so-dump" class="headerlink" title="so dump"></a>so dump</h5><p>主包主包，挨个打印确实很犀利，但是太吃操作了，有没有更强势的打法？有的兄弟，有的。还可以将内存中的so dump下来，毕竟so总是要执行的</p>
<blockquote>
<p>直接打印内存中的字符串，一般都是解密状态，但是太过繁琐</p>
<p>使用jnitrace，缺点是只能查看jni相关的函数，最大的缺点是我配置不上。。。</p>
<p>从内存中dump整个so，确实爽，缺点是需要修复。</p>
<p>还有一个方法就是分析so中的解密函数，进行还原。这个比较有难度</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">dump_so</span>(<span class="params">so_name</span>) &#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> currentApplication = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.app.ActivityThread&quot;</span>).<span class="title function_">currentApplication</span>();</span><br><span class="line">        <span class="keyword">var</span> dir = currentApplication.<span class="title function_">getApplicationContext</span>().<span class="title function_">getFilesDir</span>().<span class="title function_">getPath</span>();</span><br><span class="line">        <span class="keyword">var</span> libso = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(so_name);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[name]:&quot;</span>, libso.<span class="property">name</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[base]:&quot;</span>, libso.<span class="property">base</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[size]:&quot;</span>, <span class="title function_">ptr</span>(libso.<span class="property">size</span>));</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[path]:&quot;</span>, libso.<span class="property">path</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> file_path = dir + <span class="string">&quot;/&quot;</span> + libso.<span class="property">name</span> + <span class="string">&quot;_&quot;</span> + libso.<span class="property">base</span> + <span class="string">&quot;_&quot;</span> + libso.<span class="property">size</span> + <span class="string">&quot;_&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>() + <span class="string">&quot;.so&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> file_handle = <span class="keyword">new</span> <span class="title class_">File</span>(file_path, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (file_handle &amp;&amp; file_handle != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="title class_">Memory</span>.<span class="title function_">protect</span>(<span class="title function_">ptr</span>(libso.<span class="property">base</span>), libso.<span class="property">size</span>, <span class="string">&quot;rwx&quot;</span>)</span><br><span class="line">            <span class="keyword">var</span> libso_buffer = <span class="title function_">ptr</span>(libso.<span class="property">base</span>).<span class="title function_">readByteArray</span>(libso.<span class="property">size</span>);</span><br><span class="line">            file_handle.<span class="title function_">write</span>(libso_buffer);</span><br><span class="line">            file_handle.<span class="title function_">flush</span>();</span><br><span class="line">            file_handle.<span class="title function_">close</span>();</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[dump path]:&quot;</span>, file_path);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>主动执行完方法后，去对于路径pull出来so文件，这个路径应该是没权限的，需要转移到其他路径下进行pull</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250329165504941.png" alt="image-20250329165504941"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">adb shell</span><br><span class="line">su</span><br><span class="line">cd /data/user/0/com.ximalaya.ting.android/files</span><br><span class="line">mv liblogin_encrypt.so_0xb304f000_57344_1743237978631.so /sdcard</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb pull /sdcard/liblogin_encrypt.so_0xb304f000_57344_1743237978631.so</span><br></pre></td></tr></table></figure>





<p>这个时候放到ida中一看，内容好像没啥区别，还有报错，这个so文件需要修复一下</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250329170340012.png" alt="image-20250329170340012"></p>
<h5 id="so修复"><a href="#so修复" class="headerlink" title="so修复"></a>so修复</h5><p><a target="_blank" rel="noopener" href="https://github.com/qweraqq/frida-dump-android-so">https://github.com/qweraqq/frida-dump-android-so</a></p>
<p>下载工具</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250329190809624.png" alt="image-20250329190809624"></p>
<p>写一个脚本，将上面从手机pull的操作和修复指令结合在一起</p>
<p>注意脚本中的导出的位置，以及sofixer的位置是我电脑上的位置，可以改成自己的就可以正常使用了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; execSync, spawn &#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">auto</span>(<span class="params">url, num</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> so_name = url.<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>).<span class="title function_">pop</span>();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="title function_">execSync</span>(<span class="string">&#x27;adb shell&#x27;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;adb shell success&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title function_">execSync</span>(<span class="string">`adb shell su -c &quot;mv <span class="subst">$&#123;url&#125;</span> /sdcard/ &amp;&amp; exit &amp;&amp; exit&quot;`</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;su and mv success&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title function_">execSync</span>(<span class="string">`adb pull /sdcard/<span class="subst">$&#123;so_name&#125;</span> D:/desktop`</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pull success&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> addressList = so_name.<span class="title function_">split</span>(<span class="string">&#x27;_&#x27;</span>);</span><br><span class="line">        <span class="keyword">let</span> address = addressList[addressList.<span class="property">length</span> - <span class="number">3</span>]</span><br><span class="line">        <span class="keyword">let</span> child = <span class="title function_">spawn</span>(<span class="string">`D:/SoFixer/SoFixer_x<span class="subst">$&#123;num&#125;</span>.exe`</span>, [<span class="string">&#x27;-s&#x27;</span>, <span class="string">`D:/desktop/<span class="subst">$&#123;so_name&#125;</span>`</span>, <span class="string">&#x27;-o&#x27;</span>, <span class="string">`D:/desktop/fix.so`</span>, <span class="string">&#x27;-m&#x27;</span>, address, <span class="string">&#x27;-d&#x27;</span>])</span><br><span class="line">        child.<span class="property">stdout</span>.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="title function_">toString</span>());</span><br><span class="line">        &#125;);</span><br><span class="line">        child.<span class="property">stderr</span>.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(data.<span class="title function_">toString</span>());</span><br><span class="line">        &#125;);</span><br><span class="line">        child.<span class="title function_">on</span>(<span class="string">&#x27;exit&#x27;</span>, <span class="function">(<span class="params">code</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`child process exited with code <span class="subst">$&#123;code&#125;</span>`</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Done!&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`exec error: <span class="subst">$&#123;error.message&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// auto(&quot;/data/user/0/com.ximalaya.ting.android/files/liblogin_encrypt.so_0xb304f000_57344_1743244730235.so&quot;, 32);</span></span><br></pre></td></tr></table></figure>

<p><img src="/../%E5%9B%BE%E7%89%87/image-20250329191238781.png" alt="image-20250329191238781"></p>
<p>修复之后的so，就显得很正常了，已经很诗人了，不像之前的加密的字符串，完全不诗人</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250329191400817.png" alt="image-20250329191400817"></p>
<blockquote>
<p>dump下来的so仅可用于静态分析，是没办法给他塞回去运行的。</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-272077.htm">https://bbs.kanxue.com/thread-272077.htm</a></p>
<p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-191649.htm">https://bbs.kanxue.com/thread-191649.htm</a></p>
<h5 id="so何时被加载？"><a href="#so何时被加载？" class="headerlink" title="so何时被加载？"></a>so何时被加载？</h5><p>在so进行hook的时候如果这个so没有被加载，可能就会报错 &#x3D;&#x3D;cannot read property add of null&#x3D;&#x3D; </p>
<p>因为so没有被加载 Module.findBaseAddress 获取到的就是null，而null是没有add方法的，就会报错</p>
<p>so是在Java类中的static静态代码块中加载的，也就是说Java类中的静态代码块中加载了so，才能找到并hook这个so。</p>
<p>因此就需要先让so加载，再hook，还可以hookso的加载函数，监听函数，一加载上就hook</p>
<h3 id="修改函数数值参数和返回值"><a href="#修改函数数值参数和返回值" class="headerlink" title="修改函数数值参数和返回值"></a>修改函数数值参数和返回值</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libxiaojianbang.so&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> address = soAddr.<span class="title function_">add</span>(<span class="number">0x165C</span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(address, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">        args[<span class="number">2</span>] = <span class="title function_">ptr</span>(<span class="number">0x1000</span>)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[2]: &quot;</span> + args[<span class="number">2</span>]);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[3]: &quot;</span> + args[<span class="number">3</span>]);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[4]: &quot;</span> + args[<span class="number">4</span>]);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">        retval.<span class="title function_">replace</span>(<span class="number">0x1000</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;return: &quot;</span> + retval);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 数值参数使用 ptr(num) 来修改</span></span><br><span class="line"><span class="comment">// ptr 是 new NativePointer 的简写</span></span><br><span class="line"><span class="comment">// 返回值利用 retval.replace() 来修改</span></span><br></pre></td></tr></table></figure>



<p><img src="/../%E5%9B%BE%E7%89%87/image-20250330172148686.png" alt="image-20250330172148686"></p>
<h3 id="修改字符串参数"><a href="#修改字符串参数" class="headerlink" title="修改字符串参数"></a>修改字符串参数</h3><p>修改字符串比修改数值要麻烦的多，因为 ptr 需要的是一个指针即可，args的存的也是一个指针，这个指针指向字符串</p>
<h4 id="function-1-修改地址指向的字符串（了解）"><a href="#function-1-修改地址指向的字符串（了解）" class="headerlink" title="function 1 修改地址指向的字符串（了解）"></a>function 1 修改地址指向的字符串（了解）</h4><p>将char *指向的字符串修改掉。</p>
<p>新字符串一般不超过源字符串长度，因为地址中的字符串是连着的，如果超过了原先的字符串长度，可能将其他的字符串也修改掉，那就不好了。还需要主要字符串结尾是否存在两个字节0，用作字符串结束标志。还需要对要更改的内容进行判断以免导致后面的代码不能正常运行。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">stringToHex</span>(<span class="params">str</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> str.<span class="title function_">split</span>(<span class="string">&quot;&quot;</span>).<span class="title function_">map</span>(<span class="keyword">function</span> (<span class="params">c</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="string">&quot;0&quot;</span> + c.<span class="title function_">charCodeAt</span>(<span class="number">0</span>).<span class="title function_">toString</span>(<span class="number">16</span>)).<span class="title function_">slice</span>(-<span class="number">2</span>);</span><br><span class="line">    &#125;).<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">stringToBytes</span>(<span class="params">str</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">hexToBytes</span>(<span class="title function_">stringToHex</span>(str))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hexToBytes</span>(<span class="params">hex</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> bytes = [], c = <span class="number">0</span>; c &lt; hex.<span class="property">length</span>; c+=<span class="number">2</span>) </span><br><span class="line">    bytes.<span class="title function_">push</span>(<span class="built_in">parseInt</span>(hex.<span class="title function_">substr</span>(c, <span class="number">2</span>), <span class="number">16</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> bytes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hexToString</span>(<span class="params">hexStr</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> hex = hexStr.<span class="title function_">toString</span>();</span><br><span class="line">    <span class="keyword">var</span> str = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; hex.<span class="property">length</span>; i += <span class="number">2</span>) &#123;</span><br><span class="line">        str += <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(<span class="built_in">parseInt</span>(hex.<span class="title function_">substr</span>(i, <span class="number">2</span>), <span class="number">16</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改字符串参数</span></span><br><span class="line"><span class="comment">// 直接修改char *内容</span></span><br><span class="line"><span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libxiaojianbang.so&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> address = soAddr.<span class="title function_">add</span>(<span class="number">0x1D68</span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(address, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (args[<span class="number">1</span>].<span class="title function_">readCString</span>() == <span class="string">&quot;xiaojianbang&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> newStr = <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">            <span class="comment">// console.log(hexToBytes(stringToBytes(newStr)))</span></span><br><span class="line">            args[<span class="number">1</span>].<span class="title function_">writeByteArray</span>(<span class="title function_">hexToBytes</span>(<span class="title function_">stringToHex</span>(newStr) + <span class="string">&quot;00&quot;</span>));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[1]: &quot;</span> + <span class="title function_">hexdump</span>(args[<span class="number">1</span>]));</span><br><span class="line">            args[<span class="number">2</span>] = <span class="title function_">ptr</span>(newStr.<span class="property">length</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(args[<span class="number">2</span>].<span class="title function_">toInt32</span>());</span><br><span class="line">        &#125;     </span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;); </span><br></pre></td></tr></table></figure>



<p><img src="/../%E5%9B%BE%E7%89%87/image-20250331163934726.png" alt="image-20250331163934726"></p>
<h4 id="function-2-修改地址（了解）"><a href="#function-2-修改地址（了解）" class="headerlink" title="function 2 修改地址（了解）"></a>function 2 修改地址（了解）</h4><p>将so中已有的字符串地址传给函数</p>
<p>这种方法也是很有局限性，只能选择内存中已有的字符串</p>
<p>shift + F12 挑一个喜欢的字符串</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250331172720113.png" alt="image-20250331172720113"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libxiaojianbang.so&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> address = soAddr.<span class="title function_">add</span>(<span class="number">0x1D68</span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(address, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (args[<span class="number">1</span>].<span class="title function_">readCString</span>() == <span class="string">&quot;xiaojianbang&quot;</span>) &#123;</span><br><span class="line">            <span class="comment">// function 2 将已有的字符串地址传递给args[1](狸猫换太子)</span></span><br><span class="line">            args[<span class="number">1</span>] = soAddr.<span class="title function_">add</span>(<span class="number">0xBB1</span>);</span><br><span class="line">            args[<span class="number">2</span>] = <span class="title function_">ptr</span>(soAddr.<span class="title function_">add</span>(<span class="number">0xBB1</span>).<span class="title function_">readCString</span>().<span class="property">length</span>)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[1]: &quot;</span> + <span class="title function_">hexdump</span>(args[<span class="number">1</span>]));</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[2]: &quot;</span> + args[<span class="number">2</span>].<span class="title function_">toInt32</span>());</span><br><span class="line">        &#125;     </span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;); </span><br></pre></td></tr></table></figure>

<p><img src="/../%E5%9B%BE%E7%89%87/image-20250331173732081.png" alt="image-20250331173732081"></p>
<h4 id="function-3-修改结构体（了解）"><a href="#function-3-修改结构体（了解）" class="headerlink" title="function 3 修改结构体（了解）"></a>function 3 修改结构体（了解）</h4><p>修改结构体（只针对MD5算法）结构体中的buffer</p>
<p>结构体定义的时候定义了一个两字节的表示字符数量的，还有四个初始化常量，占4字节</p>
<p>（2+4）*8 &#x3D; 48 那就是24个十六进制对，从第25位开始取就是明文，可以在 onLeave 中更改字符串，达到更改的目的。</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250331191331466.png" alt="image-20250331191331466"></p>
<p>其实这个主要还是了解一下结构体，掌握如果更改结构体</p>
<h4 id="function-4-构建字符串（重要）"><a href="#function-4-构建字符串（重要）" class="headerlink" title="function 4 构建字符串（重要）"></a>function 4 构建字符串（重要）</h4><p>利用frida的API来构建字符串</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Memory.alloc()</span><br><span class="line">Memory.allocUtf8String()</span><br><span class="line">Memory.allocUtf16String()</span><br></pre></td></tr></table></figure>



<p>利用这个API将字符串处理返回一个指针类型（NativePointer），但是有一个问题就是使用的时候需要考虑作用域的问题，如果是在hook so层函数的时候的 onEnter中接收存储这个指针的话，随着onEnter函数执行完毕，内存指针就会被释放，释放之后再执行要hook的函数，hook了个寂寞。因此需要用全局变量，或者在函数外定义参数来接收指针，防止释放。</p>
<p>使用this保障指针在函数执行前不被释放</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libxiaojianbang.so&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> address = soAddr.<span class="title function_">add</span>(<span class="number">0x1D68</span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(address, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">args0</span> = args[<span class="number">0</span>];</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">args1</span> = args[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span> (args[<span class="number">1</span>].<span class="title function_">readCString</span>() == <span class="string">&quot;xiaojianbang&quot;</span>) &#123;</span><br><span class="line">            <span class="comment">// function 4 构建字符串</span></span><br><span class="line">            <span class="keyword">var</span> newStr = <span class="string">&quot;skjhgjsdhgf&#x27;;dlfsdlkhskd&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 错误示范一，直接给予args[1]一个指针的话会出现异常，打印出来的args[1]异常</span></span><br><span class="line">            <span class="comment">// args[1] = Memory.allocUtf8String(newStr)    </span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 错误示范二，用变量接收指针，再将变量给args[1],虽然打印结果正常，但是onEnter执行完毕指针内存释放了，导致后续操作异常</span></span><br><span class="line">            <span class="comment">// var a = Memory.allocUtf8String(newStr) </span></span><br><span class="line">            <span class="comment">// args[1] = a</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 正确操作</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">newStrAdd</span> = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(newStr)</span><br><span class="line">            args[<span class="number">1</span>] = <span class="variable language_">this</span>.<span class="property">newStrAdd</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[1]: &quot;</span> + <span class="title function_">hexdump</span>(args[<span class="number">1</span>]));</span><br><span class="line">            args[<span class="number">2</span>] = <span class="title function_">ptr</span>(newStr.<span class="property">length</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;args[2]: &quot;</span> + args[<span class="number">2</span>].<span class="title function_">toInt32</span>());</span><br><span class="line">        &#125;     </span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;); </span><br></pre></td></tr></table></figure>



<p>这个原理和之前将arg[0]，使用 this.xxx 接收，然后再在 onLeave 中打印使用是一样的，因为 var定义的参数会在 onEnter 执行结束后释放，要使用this来延长生命周期。</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250401172536122.png" alt="image-20250401172536122"></p>
<p>或者在函数外构建字符串，在hook时使用（定义生命周期更长的变量？）</p>
<h3 id="hook-dlopen"><a href="#hook-dlopen" class="headerlink" title="hook_dlopen"></a>hook_dlopen</h3><p>之前的hook方法有一个bug就是需要so被加载之后才能进行hook操作，否则报错</p>
<p>&#x3D;&#x3D;cannot read property add of null&#x3D;&#x3D; ，这个时候就有问题，如果有的so只执行一次，那不寄了，这个时候就需要hook_dlopen了</p>
<p>dlopen，此物在NDK开发中亦有记载</p>
<p>hook_dlopen 的作用是视奸so何时被加载，加载之后立马hook。</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250401183540864.png" alt="image-20250401183540864"></p>
<p>原理就是so的加载需要调用这个dlopen函数，只需要hook掉这个函数，看看什么so文件被加载了，监听一下成功被加载就执行hook函数，这样就避免了上方的报错了。dlopen存在两个一个用于低版本（dlopen）一个用于高版本（android_dlopen_ext）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> dlopen = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&#x27;dlopen&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(dlopen)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> android_dlopen_ext = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&#x27;android_dlopen_ext&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(android_dlopen_ext)</span><br><span class="line"></span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(dlopen, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> soPath = args[<span class="number">0</span>].<span class="title function_">readCString</span>();</span><br><span class="line">        <span class="keyword">if</span> (soPath.<span class="title function_">indexOf</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>) != -<span class="number">1</span>) <span class="variable language_">this</span>.<span class="property">hook</span> = <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">hook</span>) <span class="title function_">hookFunc</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(android_dlopen_ext, &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> soPath = args[<span class="number">1</span>].<span class="title function_">readCString</span>();</span><br><span class="line">        <span class="keyword">if</span> (soPath.<span class="title function_">indexOf</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>) != -<span class="number">1</span>) <span class="variable language_">this</span>.<span class="property">hook</span> = <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">hook</span>) <span class="title function_">hookFunc</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<p>稍微改吧改吧封装成一个function，只有两个参数一个是要hook的so的名称，一个是so加载后执行的hook方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_dlopen</span>(<span class="params">soName, hook_func</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> dlopen = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&#x27;dlopen&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> android_dlopen_ext = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&#x27;android_dlopen_ext&#x27;</span>);</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(dlopen, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> soPath = args[<span class="number">0</span>].<span class="title function_">readCString</span>();</span><br><span class="line">            <span class="keyword">if</span> (soPath.<span class="title function_">indexOf</span>(soName) != -<span class="number">1</span>) <span class="variable language_">this</span>.<span class="property">hook</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">hook</span>) <span class="title function_">hook_func</span>()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(android_dlopen_ext, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> soPath = args[<span class="number">0</span>].<span class="title function_">readCString</span>();</span><br><span class="line">            <span class="keyword">if</span> (soPath.<span class="title function_">indexOf</span>(soName) != -<span class="number">1</span>) <span class="variable language_">this</span>.<span class="property">hook</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">hook</span>) <span class="title function_">hook_func</span>()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="内存读写"><a href="#内存读写" class="headerlink" title="内存读写"></a>内存读写</h3><p>这些方法已经使用过了，做个总结</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&quot;libc.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取指定地址的字符串  readCString()</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(soAddr.<span class="title function_">add</span>(<span class="number">0x2C10</span>).<span class="title function_">readCString</span>())</span><br><span class="line"></span><br><span class="line"><span class="comment">// dump指定地址内存   hexdump()</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(soAddr.<span class="title function_">add</span>(<span class="number">0x2C10</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读指定地址的内存  readByteArray()</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(soAddr.<span class="title function_">add</span>(<span class="number">0x2C10</span>).<span class="title function_">readByteArray</span>(<span class="number">16</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Memory</span>.<span class="title function_">readByteArray</span>(soAddr.<span class="title function_">add</span>(<span class="number">0x2C10</span>), <span class="number">16</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 写指定地址的内存 writeByteArray()</span></span><br><span class="line">soAddr.<span class="title function_">add</span>(<span class="number">0x2C10</span>).<span class="title function_">writeByteArray</span>(<span class="title function_">stringToBytes</span>(<span class="string">&quot;test&quot;</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(soAddr.<span class="title function_">add</span>(<span class="number">0x2C10</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 申请新内存写入</span></span><br><span class="line"><span class="title class_">Memory</span>.<span class="title function_">alloc</span>()</span><br><span class="line"><span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改内存权限</span></span><br><span class="line"><span class="title class_">Memory</span>.<span class="title function_">protect</span>(<span class="title function_">ptr</span>(libso.<span class="property">base</span>), libso.<span class="property">size</span>, <span class="string">&#x27;rwx&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h4 id="读"><a href="#读" class="headerlink" title="读"></a>读</h4><p>readCString是读取到字符串结尾 00 为止，readByteArray是读取给定的字节。还有readPointer（读取一个指针长度，返回NativePointer指针类型）readInt（读取四个字节，当作整数来读返回number类型，还会有字节序的处理）还有readS8、readS16、readS32等，这个S表示有符号数，意思是读取一个有正负的字节，将最高位当作符号位，还有U8、U16等，U表示无符号位，最高位正常解析。方法有很多，还是根据需要用</p>
<h4 id="写"><a href="#写" class="headerlink" title="写"></a>写</h4><p>write也是有一套和read差不多的方法。</p>
<p>writeByteArray() 接收两种参数类型，一种是ArrayBuffer,，另一种是number，加上之前封装的方法，就是一个用 stringToBytes 转换，一个用 hexToBytes 转换。</p>
<p>申请内存写入的时候常用的是 alloc还有allocUtf8String，如果使用 alloc 写入字符串的话需要手动添加结尾 \0 使用 allocUtf8String 就不需要</p>
<h3 id="ARM汇编"><a href="#ARM汇编" class="headerlink" title="ARM汇编"></a>ARM汇编</h3><p>so文件的hook中是可以使用API修改汇编达到修改方法的目的的，因此还需要了解一下ARM汇编。</p>
<p>so中有使用ARM32、ARM64、X86、X86_64的汇编。</p>
<p>在ARM64中有 <code>x0-x30</code> 的寄存器，这些 <code>x</code> 开头的寄存器是64位的</p>
<p><code>w</code> 开头的寄存器是32位的，一般64位的代码也会出现 <code>w</code> 寄存器，因为要考虑兼容为题，<code>w</code> 型的寄存器是从 <code>x</code> 寄存器中分离出来的，可以理解为 <code>w2</code> 寄存器是 <code>x2</code> 寄存器的一部分。在64为中，如果使用的数值比较少就会被放到 <code>w</code> 寄存器里，如果是一个指针什么的用到的数值比较大才会被放到 <code>x</code> 寄存器内</p>
<p><code>sp</code> 属于栈寄存器，这里的<code>SP</code> 是一个申请栈空间的操作，<code>SUB</code> 表示操作减，因为在ARM64汇编中栈地址是从高地址到低地址（先进后出，压栈）（栈帧是从低地址到高地址），因此需要减去空间。减的时候减 0x10 的倍数，因为ARM汇编要求汇编对齐，要是16的整数倍</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/chanchan/p/7820508.html">把大端、小端与堆、栈的生长方向联系起来记忆 - 蝉蝉 - 博客园</a></p>
<p>放一篇可以增强堆栈方向记忆的文章</p>
<p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/29520755">栈为什么要由高地址向低地址扩展？ - 知乎</a></p>
<p>ARM汇编参数是在寄存器中传递的，arm32中的参数通过R0-R3传递，如果参数超过四个就会通过栈传递 ，arm64中参数传递通过X0-X7传递，如果参数超过8个就会通过栈传递</p>
<p>进入函数的第一步就是使用 <code>STR</code> 将函数参数保存。</p>
<p>提升栈空间，保存参数之后，才真正的开始执行代码， <code>LDR</code> 表示读内存，将内存中的内容加载到寄存器中去，数据只有在寄存器中才可以进行运算。</p>
<p><code>ADD</code> 表示相加 W8+W9 结果放到W8中</p>
<p>最终的结果会放到X0中去，X0寄存器也是用来存放最终结果的，因为返回值是int类型，32位就够用了，就使用了W0</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LDR             W8, [SP,#0x20+var_14]</span><br><span class="line">LDR             W9, [SP,#0x20+var_18]</span><br><span class="line">ADD             W8, W8, W9</span><br><span class="line">LDR             W9, [SP,#0x20+var_1C]</span><br><span class="line">ADD             W0, W8, W9</span><br></pre></td></tr></table></figure>



<p>栈结束的时候使用 <code>ADD</code> 将栈空间恢复</p>
<p><code>RET</code> 用于函数返回</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250401202642596.png" alt="image-20250401202642596"></p>
<p>跟大佬了解了一下exe汇编的一些操作，STR的操作相当于 push，Inter汇编中有两个指针 ebp 和 esp ARM中只有一个 sp 类似于 esp。</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250402110250128.png" alt="image-20250402110250128"></p>
<p>ARM指令转换Hex <a target="_blank" rel="noopener" href="https://armconverter.com/">https://armconverter.com</a></p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250402160118080.png" alt="image-20250402160118080"></p>
<p>同样的ARM汇编也是可以更改的，如果我想要更改 ADD 为 SUB 只需要将hex的 <code>00 01 09 0B</code> 更改为 <code>00 01 09 4B</code> </p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250402160236638.png" alt="image-20250402160236638"></p>
<h3 id="frida修改so层代码"><a href="#frida修改so层代码" class="headerlink" title="frida修改so层代码"></a>frida修改so层代码</h3><p>在Java层hook中是以函数为单位的，只能修改函数的参数返回值，进行主动调用等一些操作，但是不能直接对函数内的函数体进行修改，而so层的hook可以直接修改汇编指令，达到修改函数体的目的。非常强大。</p>
<p>上文也提到过一些，原理就是修改汇编代码。做练习frida labs0x0B 的时候也需要修改汇编达到目的</p>
<p>dump一下函数所在的地址可以看到hex的结果就是IDA左边的汇编指令，更改这个hex就可以达到更改汇编代码的效果</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250402162511809.png" alt="image-20250402162511809"></p>
<h4 id="使用writer"><a href="#使用writer" class="headerlink" title="使用writer"></a>使用writer</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libxiaojianbang.so&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> address = soAddr.<span class="title function_">add</span>(<span class="number">0x1684</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改内存权限为可读可写可执行</span></span><br><span class="line"><span class="title class_">Memory</span>.<span class="title function_">protect</span>(address, <span class="number">0x1000</span>, <span class="string">&#x27;rwx&#x27;</span>);</span><br><span class="line"><span class="comment">// address.writeByteArray(hexToBytes(&quot;0001094B&quot;));  两种方法都可以</span></span><br><span class="line"><span class="title class_">Memory</span>.<span class="title function_">writeByteArray</span>(address, [<span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x09</span>, <span class="number">0x4B</span>]);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(address))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将对应地址的指令解释成汇编</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Instruction</span>.<span class="title function_">parse</span>(address).<span class="title function_">toString</span>())</span><br></pre></td></tr></table></figure>

<p>确实生效了</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250402164936392.png" alt="image-20250402164936392"></p>
<h4 id="使用frida-API"><a href="#使用frida-API" class="headerlink" title="使用frida API"></a>使用frida API</h4><p>frida内是有API进行汇编指令修改的操作的</p>
<p>也是有一大串put方法，可以参考frida API文档食用。putBytes和putU8比较常用，都是传入十六进制数一个是hex 一个是 0x，如果这写put方法是拿出来单独使用的话最后还要补上 flush()。putRet() 是直接写入ret返回这个函数了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libxiaojianbang.so&#x27;</span>);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Arm64Writer</span>(soAddr.<span class="title function_">add</span>(<span class="number">0x167C</span>)).<span class="title function_">putNop</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Instruction</span>.<span class="title function_">parse</span>(soAddr.<span class="title function_">add</span>(<span class="number">0x167C</span>)).<span class="title function_">toString</span>())</span><br></pre></td></tr></table></figure>

<p><img src="/../%E5%9B%BE%E7%89%87/image-20250402170520698.png" alt="image-20250402170520698"></p>
<h4 id="使用Memory-patchCode"><a href="#使用Memory-patchCode" class="headerlink" title="使用Memory.patchCode"></a>使用Memory.patchCode</h4><p>也是官方文档里比较推荐的一种写法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libxiaojianbang.so&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> address = soAddr.<span class="title function_">add</span>(<span class="number">0x1684</span>);</span><br><span class="line"><span class="title class_">Memory</span>.<span class="title function_">protect</span>(address, <span class="number">0x1000</span>, <span class="string">&#x27;rwx&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Memory</span>.<span class="title function_">patchCode</span>(address, <span class="number">4</span>, <span class="keyword">function</span> (<span class="params">code</span>) &#123;</span><br><span class="line">    <span class="comment">// 这里的pc是寄存器，指示代码运行到的位置</span></span><br><span class="line">    <span class="keyword">var</span> writer = <span class="keyword">new</span> <span class="title class_">Arm64Writer</span>(code, &#123; <span class="attr">pc</span>: address &#125;);</span><br><span class="line">    writer.<span class="title function_">putBytes</span>(<span class="title function_">hexToBytes</span>(<span class="string">&quot;0001094B&quot;</span>));</span><br><span class="line">    writer.<span class="title function_">flush</span>();</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>





<h3 id="so主动调用"><a href="#so主动调用" class="headerlink" title="so主动调用"></a>so主动调用</h3><p>之前的hook使用 <code>Interceport.attach</code> 那种方法是函数被执行时才进行hook，和Java层中的 <code>类名.方法名.implementation</code> 一样</p>
<p>回忆一下Java层主动调用的方法，主要是获取（创建）对象，调用对象内的Java方法</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250402173121170.png" alt="image-20250402173121170"></p>
<p>so层的主动调用类似于NDK开发中的一个so去调用另一个so的操作，使用dlopen找到地址，强转成函数指针，然后进行调用。so的主动调用则是需要先拿到一个函数地址，然后声明函数指针，最后进行函数调用</p>
<h4 id="声明函数指针"><a href="#声明函数指针" class="headerlink" title="声明函数指针"></a>声明函数指针</h4><p><a target="_blank" rel="noopener" href="https://frida.re/docs/javascript-api/#nativefunction">https://frida.re/docs/javascript-api/#nativefunction</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明函数指针，第一个参数传入函数地址，第二个参数传入函数返回值类型，第三个数组参数传入函数参数类型</span></span><br><span class="line"><span class="keyword">var</span> jstr2cstr = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(address, <span class="string">&#x27;pointer&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>])</span><br></pre></td></tr></table></figure>



<h4 id="构建参数"><a href="#构建参数" class="headerlink" title="构建参数"></a>构建参数</h4><p>构建env参数的时候有两个获取env方法，分别是 <code>getEnv()</code> 和 <code>tryGetEnv()</code> ，getEnv如果没获取到env的话会报错，tryGetEnv 如果没获取到 env的话会返回一个null。 </p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250402185945047.png" alt="image-20250402185945047"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libxiaojianbang.so&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> address = soAddr.<span class="title function_">add</span>(<span class="number">0x124C</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 声明函数指针，第一个参数传入函数地址，第二个参数传入函数返回值类型，第三个数组参数传入函数参数类型</span></span><br><span class="line"><span class="keyword">var</span> jstr2cstr = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(address, <span class="string">&#x27;pointer&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">// 构建参数</span></span><br><span class="line"><span class="comment">// 如果这里得不到env可以尝试将整个代码放到 Java.perfrom 中去，一般带有 Java 的API需要在Java.perfrom中运行</span></span><br><span class="line"><span class="keyword">var</span> env = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;env: &quot;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(env))</span><br><span class="line"><span class="comment">// jstring 使用 env 来构建</span></span><br><span class="line"><span class="keyword">var</span> jstr = env.<span class="title function_">newStringUtf</span>(<span class="string">&#x27;hello world&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;jstr: &quot;</span>,<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(jstr))</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> cstr = <span class="title function_">jstr2cstr</span>(env, jstr);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(cstr))</span><br></pre></td></tr></table></figure>



<p>在so中可以直接看到的都是CString，Java类型的string在虚拟机里正常，在so中是显示不出来的，比如代码中创建的jstr在hook的时候打印出来的结果是0x1，查看不了字符串内容</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250402191558203.png" alt="image-20250402191558203"></p>
<h3 id="hook-libc-读写文件"><a href="#hook-libc-读写文件" class="headerlink" title="hook libc 读写文件"></a>hook libc 读写文件</h3><p>frida的API仅有写出文件的操作</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> file_handle = <span class="keyword">new</span> <span class="title class_">File</span>(file_path, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">file_handle.<span class="title function_">write</span>()</span><br><span class="line">file_handle.<span class="title function_">flush</span>()</span><br><span class="line">file_handle.<span class="title function_">close</span>()</span><br></pre></td></tr></table></figure>



<p>没有读文件的操作，想要读文件就只能去hook libc了，libc也支持写文件的操作</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">readTxt</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> fopenAddr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&#x27;libc.so&#x27;</span>, <span class="string">&#x27;fopen&#x27;</span>)</span><br><span class="line">    <span class="keyword">var</span> fputsAddr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&#x27;libc.so&#x27;</span>, <span class="string">&#x27;fputs&#x27;</span>)</span><br><span class="line">    <span class="keyword">var</span> floseAddr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&#x27;libc.so&#x27;</span>, <span class="string">&#x27;fclose&#x27;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(fopenAddr, fputsAddr, floseAddr)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> fopen = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(fopenAddr, <span class="string">&#x27;pointer&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>])</span><br><span class="line">    <span class="keyword">var</span> fputs = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(fputsAddr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>])</span><br><span class="line">    <span class="keyword">var</span> fclose = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(floseAddr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>])</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 注意路径要在包名所在的文件夹下，其他文件夹八成没有权限进行写入操作</span></span><br><span class="line">    <span class="keyword">var</span> fileName = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(<span class="string">&#x27;/data/data/com.xiaojianbang.app/test.txt&#x27;</span>)</span><br><span class="line">    <span class="keyword">var</span> openModule = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(<span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">    <span class="keyword">var</span> str = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(<span class="string">&#x27;hello world\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> file = <span class="title function_">fopen</span>(fileName, openModule);</span><br><span class="line">    <span class="title function_">fputs</span>(str, file)</span><br><span class="line">    <span class="title function_">fclose</span>(file)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../%E5%9B%BE%E7%89%87/image-20250402205425905.png" alt="image-20250402205425905"></p>
<h3 id="jni函数的hook"><a href="#jni函数的hook" class="headerlink" title="jni函数的hook"></a>jni函数的hook</h3><p>jnitreach非常好，要是我能用就更好了。学一下怎么手动hook jni的函数吧</p>
<p>首先是地址获取问题</p>
<p>F1：编译后的jni是在 <code>libart.so</code> 中的，可以去这个so中去寻找jni函数的地址</p>
<p>F2：jni函数来自于jnienv，而这个jnienv本质上是一个结构体，结构体内都是函数指针，只要能够定位到结构体，再根据函数在结构体内的偏移，就可以获取函数的地址值</p>
<h4 id="hook-libart"><a href="#hook-libart" class="headerlink" title="hook libart"></a>hook libart</h4><p><code>libart.so</code> 并不是在apk内部的，而是在手机中</p>
<p>Android10 之前的应该是在 <code>/system/lib</code> 和 <code>/system/lib64</code> 中</p>
<p>Android10 以及Android10以后 在 <code>/system/apex/com.android.runtime.release/lib</code> 和 <code>/system/apex/com.android.runtime.release/lib64</code> 中 </p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250402211405820.png" alt="image-20250402211405820"></p>
<h5 id="枚举符号表"><a href="#枚举符号表" class="headerlink" title="枚举符号表"></a>枚举符号表</h5><p>查找字符表，然后根据名称筛选方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_jni</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> symbols = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;libart.so&quot;</span>).<span class="title function_">enumerateSymbols</span>();</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">NSUAddr</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; symbols.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> symbol = symbols[i]</span><br><span class="line">        <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&#x27;CheackJNI&#x27;</span>) == -<span class="number">1</span> &amp;&amp; symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;NewStringUTF&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(symbol.<span class="property">name</span>, symbol.<span class="property">address</span>);</span><br><span class="line">            <span class="title class_">NSUAddr</span> = symbol.<span class="property">address</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">NSUAddr</span>, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;NSUAddr: &quot;</span>, args[<span class="number">1</span>].<span class="title function_">readCString</span>());</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;NSUAddr return: &quot;</span>, retval);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="计算地址"><a href="#计算地址" class="headerlink" title="计算地址"></a>计算地址</h4><p>看个乐呵，主要还是枚举符号表进行hook，因为计算地址比较麻烦，并且在32位和64位的so中的指针分别为4字节、8字节</p>
<p>jni函数本质上来说是一个结构体，既然是结构体指针就可以根据函数定义在结构体中的位置来计算偏移找到对应的函数地址，但是这个可能会有版本问题，比如使用jni定义的位置不一样。</p>
<p>对应C语言来说 jnienv 直接就是一个 jninactiveinterface 的指针。C++来说 jnienv 是指向了一个结构体，结构体中定义了一个function，这个function是 jninactiveinterface 的指针。</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250507161605436.png" alt="image-20250507161605436"></p>
<p>因此可以说是都是 jninativeinterface的指针。因此在hook的时候可以先得到 jninative interface 这个结构体的地址</p>
<p><code>console.log(JSON.stringify(Java.vm.tryGetEnv()))</code></p>
<p>执行之后得到两个地址</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;handle&quot;</span><span class="punctuation">:</span><span class="string">&quot;0x7408e1c500&quot;</span><span class="punctuation">,</span><span class="attr">&quot;vm&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;handle&quot;</span><span class="punctuation">:</span><span class="string">&quot;0x7499b191c0&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> env = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>()</span><br><span class="line">env.<span class="property">handle</span></span><br></pre></td></tr></table></figure>

<p>env和env.handle在一定程度上是通用的，或者说会自动完成转换。但是在使用frida封装的JNI相关的API，必须使用 env</p>
<p>当参数需求JNIEnv*时，可以使用 env 或者 env.handle 。简述一下能用env就用env</p>
<p><code>0x7408e1c500</code> 这个地址指向的是 jninativeinterface 的指针</p>
<p>从dump下来的内容可以看到三个指针，很显然是不符合 jninativeinterface 结构体中全是指针的情况，这里面第一个指针是 jninativeinterface 的指针，他指向 jninativeinterface 这个结构体</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250507161912573.png" alt="image-20250507161912573"></p>
<p>读取一个指针长度，再进行dump，就可以看到与 jninativeinterface 相符的情况了，结构体前四个指针保留。这个时候才定位到 jninativeinterface 的原始结构体</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250507162401735.png" alt="image-20250507162401735"></p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250507162315845.png" alt="image-20250507162315845"></p>
<p>想要hook对应的方法，还需要数偏移，比如 FindClass 方法，64位中一个指针8个字节，需要偏移 48 字节，偏移完 48 字节之后，得到 findclass方法的地址，将这个地址当作指针来读取，就可以看到方法体的具体内容，如果只是进行hook的话，上一步已经得到了方法地址。</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250507163243014.png" alt="image-20250507163243014"></p>
<p>还可以对一下arm汇编指令，四个字节一条arm汇编</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250507164353078.png" alt="image-20250507164353078"></p>
<p>hook findclass 方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_jni2</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// console.log(JSON.stringify(Java.vm.tryGetEnv()))</span></span><br><span class="line">    <span class="comment">// console.log(hexdump(Java.vm.tryGetEnv().handle.readPointer()))</span></span><br><span class="line">    <span class="keyword">var</span> envAddr = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="property">handle</span>.<span class="title function_">readPointer</span>()</span><br><span class="line">    <span class="comment">// console.log(hexdump(envAddr.add(48).readPointer()))</span></span><br><span class="line">    <span class="keyword">var</span> funcAddr = envAddr.<span class="title function_">add</span>(<span class="number">48</span>).<span class="title function_">readPointer</span>()</span><br><span class="line">    <span class="comment">// console.log(Instruction.parse(funcAddr.add(4)).toString())</span></span><br><span class="line">    <span class="comment">// console.log(Instruction.parse(funcAddr.add(8)).toString())</span></span><br><span class="line">    <span class="comment">// console.log(Instruction.parse(funcAddr.add(12)).toString())</span></span><br><span class="line">    <span class="comment">// console.log(Instruction.parse(funcAddr.add(16)).toString())</span></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(funcAddr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;FindClass args[1]: &quot;</span>, args[<span class="number">1</span>].<span class="title function_">readCString</span>());</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;&#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这里第一次执行的时候多打印了一行，再执行就没有了</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250507164807174.png" alt="image-20250507164807174"></p>
<p>原因是因为加载so，执行 JNI_Onload 方法中使用了 findclass 加载了这个so，之后在点击不会进行加载操作了</p>
<h3 id="主动调用jni函数"><a href="#主动调用jni函数" class="headerlink" title="主动调用jni函数"></a>主动调用jni函数</h3><h4 id="f1-使用frida封装的函数来调用jni"><a href="#f1-使用frida封装的函数来调用jni" class="headerlink" title="f1:使用frida封装的函数来调用jni"></a>f1:使用frida封装的函数来调用jni</h4><p>上文有提到过主动调用函数，通过声明函数指针，构建参数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libxiaojianbang.so&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> address = soAddr.<span class="title function_">add</span>(<span class="number">0x124C</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 声明函数指针</span></span><br><span class="line"><span class="keyword">var</span> jstr2cstr = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(address, <span class="string">&#x27;pointer&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>])</span><br><span class="line"><span class="comment">// 构建参数</span></span><br><span class="line"><span class="keyword">var</span> env = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>();</span><br><span class="line"><span class="comment">// jstring 使用 env 来构建</span></span><br><span class="line"><span class="keyword">var</span> jstr = env.<span class="title function_">newStringUtf</span>(<span class="string">&#x27;hello world&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 主动调用</span></span><br><span class="line"><span class="keyword">var</span> cstr = <span class="title function_">jstr2cstr</span>(env, jstr);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(cstr))</span><br></pre></td></tr></table></figure>



<p>这里面就用到了 frida 封装的 jni 方法，即 <code>newStringUtf</code> 这种方法需要frdia获取的env才行，即 <code>Java.vm.tryGetEnv()</code> 很多常用的jni方法都已经被封装好了 </p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250507173151163.png" alt="image-20250507173151163"></p>
<h4 id="f2-使用nativefunction方式调用"><a href="#f2-使用nativefunction方式调用" class="headerlink" title="f2:使用nativefunction方式调用"></a>f2:使用nativefunction方式调用</h4><p>第一步就是先获取到这个方法的真实地址，也有两种方法，hook libart（通过枚举符号表，筛选地址） 和手工计算地址</p>
<p>没算出来具体的地址，这玩意逮着 jni.h 挨个数啊，整不了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">call_jni2</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> symbols = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;libart.so&quot;</span>).<span class="title function_">enumerateSymbols</span>();</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">NSUAddr</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; symbols.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> symbol = symbols[i]</span><br><span class="line">        <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&#x27;CheackJNI&#x27;</span>) == -<span class="number">1</span> &amp;&amp; symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;NewStringUTF&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(symbol.<span class="property">name</span>, symbol.<span class="property">address</span>);</span><br><span class="line">            <span class="title class_">NSUAddr</span> = symbol.<span class="property">address</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">NSUAddr</span> == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">var</span> nsufun = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(<span class="title class_">NSUAddr</span>, <span class="string">&#x27;pointer&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里是需要一个指针的，不能直接给字符串，需要利用frida的API申请内存，将内存的地址传入</span></span><br><span class="line">    <span class="keyword">var</span> res = <span class="title function_">nsufun</span>(<span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="property">handle</span>, <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(<span class="string">&#x27;hello world&#x27;</span>))</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> envAddr = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="property">handle</span>.<span class="title function_">readPointer</span>()</span><br><span class="line">    <span class="keyword">var</span> getStringUtfChars = envAddr.<span class="title function_">add</span>(<span class="number">0x550</span>).<span class="title function_">readPointer</span>()</span><br><span class="line">    <span class="keyword">var</span> get_func = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(getStringUtfChars, <span class="string">&#x27;pointer&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;pointer&#x27;</span>])</span><br><span class="line">    <span class="keyword">var</span> csting = <span class="title function_">get_func</span>(<span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>().<span class="property">handle</span>, res, <span class="title function_">ptr</span>(<span class="number">0</span>))</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(csting.<span class="title function_">readCString</span>())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="构建二级指针"><a href="#构建二级指针" class="headerlink" title="构建二级指针"></a>构建二级指针</h4><p>主动调用的时候，有可能需要的参数是一个二级指针</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">call_func</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> soAddr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libxiaojianbang.so&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> xiugaistr = soAddr.<span class="title function_">add</span>(<span class="number">0x17D0</span>);</span><br><span class="line">    <span class="keyword">var</span> xiugaistr_func = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(xiugaistr, <span class="string">&#x27;int64&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建参数的一级指针</span></span><br><span class="line">    <span class="keyword">var</span> strAdd = <span class="title class_">Memory</span>.<span class="title function_">allocUtf8String</span>(<span class="string">&quot;sagdkjsahgbdjsha&quot;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(strAdd))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 再构建一个指针，指针指向刚构建的一级指针</span></span><br><span class="line">    <span class="keyword">var</span> finalAdd  = <span class="title class_">Memory</span>.<span class="title function_">alloc</span>(<span class="number">8</span>).<span class="title function_">writePointer</span>(strAdd)</span><br><span class="line">    <span class="title function_">xiugaistr_func</span>(finalAdd)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(strAdd))</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h3 id="堆栈打印"><a href="#堆栈打印" class="headerlink" title="堆栈打印"></a>堆栈打印</h3><p>前面hook了系统函数，查看了系统函数的调用，那么包需要看一下堆栈的，找到方法</p>
<p>frida中已经有现成的了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Thread</span>.<span class="title function_">backtrace</span>(<span class="variable language_">this</span>.<span class="property">context</span>, <span class="title class_">Backtracer</span>.<span class="property">FUZZY</span>).<span class="title function_">map</span>(<span class="title class_">DebugSymbol</span>.<span class="property">fromAddress</span>).<span class="title function_">join</span>(<span class="string">&quot;\n&quot;</span>) + <span class="string">&#x27;\n&#x27;</span>);</span><br></pre></td></tr></table></figure>



<p>打印有一个特性，他给出的地址-so的基址不是准确的调用位置的，而是调用位置的一下行，因为存储的是 lor 的地址，因为方法的ARM指令是 BL，函数执行完毕会有返回的，返回的地址会存到lor寄存器中，正常就是返回之后的下一条指令的地址。因此需要注意，打印堆栈看到的函数地址，比实际的函数地址多了一条指令的地址，64位情况下是4</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250508142513917.png" alt="image-20250508142513917"></p>
<p>Backtracer有两个选项</p>
<p>FUZZY 对于任何二进制文件都有效，但是可能出现地址的误报</p>
<p>ACCURATE 并不是对任意二进制文件有效，地址会更准确</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250508143054019.png" alt="image-20250508143054019"></p>
<p>将这一行拆开来看</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(soAddr)     <span class="comment">// 输出so基址</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Thread</span>.<span class="title function_">backtrace</span>(<span class="variable language_">this</span>.<span class="property">context</span>, <span class="title class_">Backtracer</span>.<span class="property">FUZZY</span>));     <span class="comment">// 获取函数栈中所有地址</span></span><br></pre></td></tr></table></figure>



<p>看一下这个backtrace</p>
<p>要两个参数，返回值是一个数组，如果这样直接执行的话，打印出来的就是一个数组，毫无阅读性。</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250517203007663.png" alt="image-20250517203007663"></p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250517203751335.png" alt="image-20250517203751335"></p>
<p>这个时候就需要 DebugSymbol.fromAddress</p>
<p>通过 DebugSymbol.fromAddress 方法来获取传入的地址附近的调试信息，返回值如下</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250517204316462.png" alt="image-20250517204316462"></p>
<p>map 和 join 就是js方法了 ，map将数组中的每一个成员都传递进后面函数作为参数，用方法的返回值替换成员，join，拼接字符串，了解完这个之后，就可以根据喜好来改造堆栈打印的结果了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Thread</span>.<span class="title function_">backtrace</span>(<span class="variable language_">this</span>.<span class="property">context</span>, <span class="title class_">Backtracer</span>.<span class="property">FUZZY</span>).<span class="title function_">map</span>(<span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="title class_">DegbugSymbol</span>.<span class="title function_">fromAddress</span>(value) + <span class="string">&quot;offset:&quot;</span> + value.<span class="title function_">sub</span>(soAddr);</span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure>



<h3 id="确认native函数在哪个so中"><a href="#确认native函数在哪个so中" class="headerlink" title="确认native函数在哪个so中"></a>确认native函数在哪个so中</h3><p>之前确定是通过静态分析来找so的，先关键代码快速定位，然后找到对应的native函数，再结合上下文看有没有加载so，这种方式找到的so可能是错的，如：函数所在的so早就加载了，因为so只要在函数执行前加载即可，并不需要一定加载在方法的附近，有的app就会在一个类中加载所有的so，其他函数调用使用的时候就不进行加载了，只剩下一个方法名，找不到对应的so</p>
<p>可以通过hook系统函数来得到绑定的native函数地址，然后再得到so地址</p>
<p>jni函数动态注册，可以hook RegisterNative</p>
<p>jni函数静态注册，可以hook dlsym</p>
<p>jni函数静态注册，其实定义静态方法的时候也不需要注册，只需要注意命名格式，当首次执行native函数时，是没有对应关系的，系统会去遍历所有的so，从导出表中找到符合命名规则的函数，如果成功找到就获取方法地址，和native函数绑定。在寻找的时候会使用到 dlsym，因此可以hook dlsym</p>
<p>jni函数动态注册的时候需要用到jni函数RegisterNative，</p>
<h4 id="hook-dlsym-静态注册"><a href="#hook-dlsym-静态注册" class="headerlink" title="hook dlsym  静态注册"></a>hook dlsym  静态注册</h4><p>dlsym 和 dlopen 是在同一个so中的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_dlsym</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> dlsymAddr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&#x27;dlsym&#x27;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(dlsymAddr)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(dlsymAddr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">args1</span> = args[<span class="number">1</span>];</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">args1</span>.<span class="title function_">readCString</span>(), retval)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>dlsym需要重新打开app hook，因为有些方法是在app加载的时候就可以绑定好了的，不需要额外触发绑定，第一次执行so层方法时触发 dlsym 方法去寻找绑定方法。只要是静态注册的方法都需要调用 dlsym</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250508184018725.png" alt="image-20250508184018725"></p>
<p>再根据得到的地址，去获取所在的模块地址，打印so名称，函数偏移</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250508185153361.png" alt="image-20250508185153361"></p>
<h4 id="hook-RegisterNative-动态注册"><a href="#hook-RegisterNative-动态注册" class="headerlink" title="hook RegisterNative 动态注册"></a>hook RegisterNative 动态注册</h4><p>RegisterNative 方法有四个参数，第一个是 jnienv ，第二个是函数所在的类名称，第三个是一个结构体，结构体内是三个指针，第四个是注册的方法个数</p>
<p>先获取类名以及方法数，然后根据方法数来分离结构体中的三个参数</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250508192242651.png" alt="image-20250508192242651"></p>
<p>兼容一下32和64位的，用 <code>Process.pointerSize</code>  来表示一个指针的长度</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_RegisterNatives</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> regAddr = <span class="literal">null</span>;</span><br><span class="line">    <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;libart.so&quot;</span>).<span class="title function_">enumerateSymbols</span>().<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">symbol</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&#x27;RegisterNatives&#x27;</span>) != -<span class="number">1</span> &amp;&amp; symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&#x27;CheckJNI&#x27;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// console.log(symbol.name, symbol.address);</span></span><br><span class="line">            regAddr = symbol.<span class="property">address</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> (regAddr == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(regAddr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> env = <span class="title class_">Java</span>.<span class="property">vm</span>.<span class="title function_">tryGetEnv</span>();</span><br><span class="line">            <span class="keyword">var</span> classname = env.<span class="title function_">getClassName</span>(args[<span class="number">1</span>])</span><br><span class="line">            <span class="keyword">var</span> methodCount = args[<span class="number">3</span>].<span class="title function_">toInt32</span>();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; methodCount; i++) &#123;</span><br><span class="line">                <span class="keyword">var</span> methodName = args[<span class="number">2</span>].<span class="title function_">add</span>(<span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span> * i).<span class="title function_">readPointer</span>().<span class="title function_">readCString</span>();</span><br><span class="line">                <span class="keyword">var</span> methodSignature = args[<span class="number">2</span>].<span class="title function_">add</span>(<span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span> * i + <span class="title class_">Process</span>.<span class="property">pointerSize</span>).<span class="title function_">readPointer</span>().<span class="title function_">readCString</span>();</span><br><span class="line">                <span class="keyword">var</span> methodAddr = args[<span class="number">2</span>].<span class="title function_">add</span>(<span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">3</span> * i + <span class="title class_">Process</span>.<span class="property">pointerSize</span> * <span class="number">2</span>).<span class="title function_">readPointer</span>();</span><br><span class="line">                <span class="keyword">var</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(methodAddr)</span><br><span class="line">                <span class="comment">// if (module == null) continue;</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(classname, methodName, methodSignature, methodAddr, <span class="variable language_">module</span>.<span class="property">name</span>, methodAddr.<span class="title function_">sub</span>(<span class="variable language_">module</span>.<span class="property">base</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../%E5%9B%BE%E7%89%87/image-20250508193835539.png" alt="image-20250508193835539"></p>
<h3 id="inline-hook"><a href="#inline-hook" class="headerlink" title="inline hook"></a>inline hook</h3><p>inlinehook 的目标是汇编指令，例如 ADD W8,  W8, W9</p>
<p>可以通过 inlinehook来查看W8寄存器中的数值，具体思路和操作ARM汇编差不多</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">inlineHook</span> () &#123;</span><br><span class="line">    <span class="keyword">var</span> nativePointer = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libxiaojianbang.so&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> address = nativePointer.<span class="title function_">add</span>(<span class="number">0x17BC</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(address, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;onEnter: &quot;</span>, <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x8</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;onLeave: &quot;</span>, <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x8</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>定位到指令所在地址，读取寄存器中的数字，同样的指针也可以读取</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250509085324392.png" alt="image-20250509085324392"></p>
<p>inlinehook的作用比较微操了，在函数执行到某一行汇编的时候打印查看参数，功能性方面感觉像是断点了，inline hook在32位的时候不稳定</p>
<h3 id="ART下的System-loadLibrary"><a href="#ART下的System-loadLibrary" class="headerlink" title="ART下的System.loadLibrary"></a>ART下的System.loadLibrary</h3><p>System.loadLibrary 是Java层加载so使用的函数，目的是了解三个函数的运行 ，JNI_Onload ，init，initarray</p>
<p>找一个在线网站，我手机是 Android 10.0.0 r1。这个的 loadLibrary 方法在 <code>libcore/ojluni/src/main/java/java/lang/System.java</code> 中，其他版本也可以搜索一下 system.java 中的 loadLibrary 方法</p>
<p>从system中的loadLibrary进入到 runtime.java 的 loadlibrary0 方法</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250509093543463.png" alt="image-20250509093543463"></p>
<p>在 loadlibrary0 方法中，处理了传入的字符串，方法是 loader.findLibrary ，接下来去找 classload 这个类，发现中间并没有进行什么操作，那么就可以看哪些类继承了 classload 复写了 findLibraay 方法</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250509113836112.png" alt="image-20250509113836112"></p>
<p>又调用了 system 中的 mapLibraryName 方法，这个方法是一个native方法</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250509114635117.png" alt="image-20250509114635117"></p>
<p>在这个C文件中，对函数进行了动态注册，NATIVE_METHOD 这个方法是将第一个和第二个参数拼接起来 使用的是 ## _ ## ，拼接成 system_mapLibraryName 。</p>
<p>然后再看这个方法， JNI_LIB_PREFIX 对应 ‘lib’  JNI_LIB_SUFFIX 对应 ‘.so’</p>
<p>这个方法将字符串拼接成了 lib+str+.so 的形式，就是需要加载的so的名称了，字数超过40的报错。然后将Cstring转成jstring返回</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250509114623082.png" alt="image-20250509114623082"></p>
<p>得到返回值之后，后面的操作是去寻找这个so的全路径，在往上走</p>
<p>在nativeLoad方法中进行加载，返回一个error判断是否加载成功</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250509203720021.png" alt="image-20250509203720021"></p>
<p>在去寻找 JVM_nativeload</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250509204244280.png" alt="image-20250509204244280"></p>
<p>先判断了是否为空，然后将 filename 转换成 cstring 调用 loadnativelibrary</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250509204314125.png" alt="image-20250509204314125"></p>
<p>先对第一个参数进行的处理 librarier 中存放的是已经加载的so，检测该so是否已经加载，如果已经加载 进入 library !&#x3D; nullptr 这个一步，未加载的没截全</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250509204553714.png" alt="image-20250509204553714"></p>
<p>如果未加载执行</p>
<p>在1005行中的 opennativelibrary 开始进行加载so的操作了</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250509205115355.png" alt="image-20250509205115355"></p>
<p>opennativelibrary 方法中还是调用了 Android_dlopen_ext 和 dlopen 方法</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250509205420488.png" alt="image-20250509205420488"></p>
<p>从 android_dlopen_ext 到 dlopen_ext 再到 do_dlopen 。到 do_dlopen 的时候已经和dlopen的方法差不多了，do_dlopen方法不必多看，只需要注意最后的地方</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250509210243620.png" alt="image-20250509210243620"></p>
<p>在 find_library 的时候完成了整个so的加载，加载完成之后，进行了一个判断，如果不为空</p>
<p>取出这个so的handle地址，还执行了一个 call_constructors 方法</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250509210456894.png" alt="image-20250509210456894"></p>
<p>在这个方法中调用了两个方法  DT_INIT 其实就是 init 方法  DT_INIT_ARRAY 是initarray 方法。这就是这两个方法被调用的时机。这个两个方法在 do_dlopen 内部被调用，因此hook do_dlopen 是不能看出变化的</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250509210844613.png" alt="image-20250509210844613"></p>
<p>再去寻找 jni_onload 的调用时机</p>
<p>循着上面 opennativelibrary 往下找，调用 findsymbol 去寻找 jni_onload 符号</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250509212911045.png" alt="image-20250509212911045"></p>
<p>通过 findsymbol 也可以看到，是走 dlsym 的，之前hook dlsym 的时候也的确有 jni_onload 的输出。</p>
<p>函数中是允许找不到符号的，因为也可能出现没定义 jni_onload 的情况，如果找到的话，就去 call jni_onload 也就是说 jni_onload 是在 LoadNativeLibrary 方法中，在dlopen方法完全执行完毕，so加载完毕之后通过 dlsym 进行调用的</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250509212529673.png" alt="image-20250509212529673"></p>
<p>调用方法，定义一个指针，将获取到的地址强转成指针，然后调用。然后按照规范返回 jni 的版本号。如果版本号不符号要求，报错。符合要求结束。这个时候也执行结束了</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250509213207012.png" alt="image-20250509213207012"></p>
<p>dlopen 执行完毕之后 通过 dlsym 方法来调用 jni_onload，如果要hook init 和 initarray 方法的话，就需要等待so加载完毕之后，init执行之前</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250509213813604.png" alt="image-20250509213813604"></p>
<h3 id="hook-initarray"><a href="#hook-initarray" class="headerlink" title="hook_initarray"></a>hook_initarray</h3><p>之前看到 init 函数和initarray函数是在 do_dlopen 方法中的 find_library 执行完毕之后，执行的 call_constructors 方法中进行调用的。</p>
<p>因此要想hook initarray的时机就是在 call_constructors 方法执行之前，在 call_constructors 执行之前so已经加载完毕了，且init和initarray方法还没有被执行。并且call_constructors 也是可以在符号表中找到的，不需要去计算地址。</p>
<p>call_constructors 方法是在 do_dlopen 方法中执行的，hook call_constructors 的时候，所有so加载的时候都会有执行，那是很糟糕的，不知道是否是自己想要hook的那个 initarray 所在的so。因此还是需要hook一下dlopen，来监听so的加载</p>
<p>这里hook的dlopen和之前hook的方式不同，之前是等待dlopen执行完毕之后再进行hook，这是在dlopen执行之前进行hook，因为init和initarray方法在dlopen执行的过程中就执行了，时机晚了就hook不到了，还有就是为了防止出现重复hook的报错（低版本报错 &#x3D;&#x3D;already replaced this function&#x3D;&#x3D; ，高版本执行多次），还有一点是hook call_constructors方法，call_constructors方法执行的时候so已经加载完毕，这个时候也就不存在，之前将hook代码放到dlopen方法之后的原因了，可以顺利找到so的基址，因此下面可以直接根据so名称来搜索。这个是一个时机问题。</p>
<p>还有一处新的地方是根据地址，重写方法， Interceptor.replace 先将地址给他，在写一个new NativeCallback，传入返回值类型以及参数类型。我的版本写  Interceptor.attach 貌似也可以</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_initarray</span>(<span class="params">soName</span>) &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">hook_dlopen2</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> dlopen = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&#x27;dlopen&#x27;</span>);</span><br><span class="line">        <span class="keyword">var</span> android_dlopen_ext = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&#x27;android_dlopen_ext&#x27;</span>);</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(dlopen, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> soPath = args[<span class="number">0</span>].<span class="title function_">readCString</span>();</span><br><span class="line">                <span class="keyword">if</span> (soPath.<span class="title function_">indexOf</span>(soName) != -<span class="number">1</span>) <span class="title function_">hook_call_constructors</span>()</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(android_dlopen_ext, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> soPath = args[<span class="number">0</span>].<span class="title function_">readCString</span>();</span><br><span class="line">                <span class="keyword">if</span> (soPath.<span class="title function_">indexOf</span>(soName) != -<span class="number">1</span>) <span class="title function_">hook_call_constructors</span>()</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">hook_dlopen2</span>()</span><br><span class="line">    <span class="keyword">var</span> ishook = <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">hook_call_constructors</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> call_constructors = <span class="literal">null</span>;</span><br><span class="line">        <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;linker64&quot;</span>).<span class="title function_">enumerateSymbols</span>().<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">symbol</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&#x27;call_constructors&#x27;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">                call_constructors = symbol.<span class="property">address</span>;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;call constructors: &quot;</span>, call_constructors)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors, &#123;</span><br><span class="line">            <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!ishook) &#123;</span><br><span class="line">                    <span class="keyword">var</span> <span class="title class_">Addr</span> = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(soName);</span><br><span class="line">                    <span class="keyword">var</span> f1 = <span class="title class_">Addr</span>.<span class="title function_">add</span>(<span class="number">0x1C54</span>);</span><br><span class="line">                    <span class="keyword">var</span> f2 = <span class="title class_">Addr</span>.<span class="title function_">add</span>(<span class="number">0x1C7C</span>);</span><br><span class="line">                    <span class="keyword">var</span> f3 = <span class="title class_">Addr</span>.<span class="title function_">add</span>(<span class="number">0x1C2C</span>);</span><br><span class="line">        </span><br><span class="line">                    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(f1, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;f1 is requested&quot;</span>)</span><br><span class="line">                    &#125;, <span class="string">&#x27;void&#x27;</span>, []))</span><br><span class="line">        </span><br><span class="line">                    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(f2, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;f2 is requested&quot;</span>)</span><br><span class="line">                    &#125;, <span class="string">&#x27;void&#x27;</span>, []))</span><br><span class="line">        </span><br><span class="line">                    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(f3, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;f3 is requested&quot;</span>)</span><br><span class="line">                    &#125;, <span class="string">&#x27;void&#x27;</span>, []))</span><br><span class="line">                    ishook = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123; &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>init和initarray的执行时机很贴近，init和initarray的hook的时机是一样的</p>
<h3 id="hook-JNIOnload"><a href="#hook-JNIOnload" class="headerlink" title="hook_JNIOnload"></a>hook_JNIOnload</h3><p>jnionload是在so文件的加载方法dlopen执行完毕之后再进行执行的，这个时候已经可以找到so的基址了，仅需要在dlopen执行完毕之后进行hook即可，不需要像initarray那样操作。但是hook必须使用dlopen，因为执行的时机很早，而且不是触发式的方法</p>
<p>可以直接hook_JNIOnload重写方法，也可以hook JNIOnload 中调用的方法，比如，开了多线程，进行检材，直接给检测方法重写掉。在实战中，还是后者比较常用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_JNIOnload</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> addr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libxiaojianbang.so&#x27;</span>)</span><br><span class="line">    <span class="keyword">var</span> funtaddr = addr.<span class="title function_">add</span>(<span class="number">0x1D68</span>)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(funtaddr, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params">env</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;JNI_OnLoad: &quot;</span>, env)</span><br><span class="line">    &#125;, <span class="string">&#x27;void&#x27;</span>, []))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">hook_dlopen</span>(<span class="string">&quot;libxiaojianbang.so&quot;</span>, hook_JNIOnload)</span><br></pre></td></tr></table></figure>



<p>如图，hook掉了一个线程，没有输出十个数字</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250517194231089.png" alt="image-20250517194231089"></p>
<h3 id="hook-pthread-create（多线程）"><a href="#hook-pthread-create（多线程）" class="headerlink" title="hook_pthread_create（多线程）"></a>hook_pthread_create（多线程）</h3><p>pthread_create是开启线程的方法，之前提到过了，如果软件要进行什么检测，肯定是开启子线程进行检测，不可能在主线程中进行。一般开启子线程是使用 pthread_create 的。</p>
<p>pthread_create在 libc.so 中</p>
<p>pthread_create有四个参数，第一个是线程ID，第二个是线程属性，第三个才是需要的函数名，第四个是函数参数</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250517195136003.png" alt="image-20250517195136003"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_pthread_create</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> pthread_create = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&#x27;pthread_create&#x27;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pthread_create_addr: &quot;</span>,pthread_create)</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(pthread_create, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;pthread_create: &quot;</span>, args[<span class="number">0</span>], args[<span class="number">1</span>], args[<span class="number">2</span>], args[<span class="number">3</span>])</span><br><span class="line">            <span class="keyword">var</span> <span class="title class_">Module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(args[<span class="number">2</span>])</span><br><span class="line">            <span class="keyword">if</span> (<span class="title class_">Module</span> != <span class="literal">null</span>) <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Module</span>.<span class="property">name</span>, args[<span class="number">2</span>].<span class="title function_">sub</span>(<span class="title class_">Module</span>.<span class="property">base</span>))</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>一些系统函数也是会调用 pthread_create 的，注意辨别哪个 so 是apk的so，再根据打印出来的地址寻找方法</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250517195740682.png" alt="image-20250517195740682"></p>
<h3 id="替换函数"><a href="#替换函数" class="headerlink" title="替换函数"></a>替换函数</h3><p>之前有用到过 <code>Interceptor.replace</code> 进行替换多线程的函数方法</p>
<p> <code>Interceptor.replace</code> 接收两个参数，第一个是要进行操作的地址指针，第二个是方法指针，说白了就是传入了俩指针</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250518200334077.png" alt="image-20250518200334077"></p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250518205309392.png" alt="image-20250518205309392"></p>
<p>之前传入第二个参数的时候使用的是 new NativeCallback </p>
<p>NativeCallback 继承 NativePointer 所以可以当作参数传入</p>
<p>func是函数的方法体</p>
<p>retType 是返回值类型</p>
<p>argTypes是参数列表</p>
<p>abi表示支持的平台，？表示可省略</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250518205457685.png" alt="image-20250518205457685"></p>
<p>进行替换的时候最好保证返回值类型相同，还需要注意参数类型和原方法的参数类型的一致性，否则包出错的，本来pointer类型需要读八个字节，整成int读四个字节，能一样吗</p>
<p>这种替换函数其实并没有真正的替换掉，原函数在内存中还是存在的，还是可以通过 NativeFunction 来进行调用原方法</p>
<p>可以通过这种方式实现一种另类的查看参数，其实这种方法和Java层的hook方法是一样的。获取类-&gt;改写类中的某个方法-&gt; 打印参数-&gt;调用原方法 -&gt;返回。只不过Java中的方法是不能进行详细的更改的，限制还是比较大的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> funt = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(funtaddr, <span class="string">&#x27;void&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>])</span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(funtaddr, <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span> (<span class="params">env</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;JNI_OnLoad: &quot;</span>, env)</span><br><span class="line">    <span class="keyword">var</span> res = <span class="title function_">funt</span>(env)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">&#125;, <span class="string">&#x27;void&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>]))</span><br></pre></td></tr></table></figure>





<h3 id="hexdump"><a href="#hexdump" class="headerlink" title="hexdump"></a>hexdump</h3><p>hexdump用于查看内存中的内容，之前用到很多，显示格式是十六进制查看，默认dump出来16*16 256个字节。这个方法是可以整一点花活的，比如信息更多，信息更少，不要十六进制头</p>
<p>offset表示从给定的地址偏移多少字节开始读取。</p>
<p>length表示一行显示多少字节，这里给默认是256，超过16字节自动换行，其实就是用来控制输出长度的。</p>
<p>header表示是否显示十六进制头</p>
<p>ansi表示进行彩色显示，只有这一种颜色，false或者true，也没啥意思</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250518213213690.png" alt="image-20250518213213690"></p>
<p>主要用到的还是 length 查看显示不完全的信息</p>
<h3 id="frida-trace"><a href="#frida-trace" class="headerlink" title="frida-trace"></a>frida-trace</h3><p>之前配置魔改过一个IDA插件traceNative，插件是将 .text 段的所有函数进行一个筛选之后输出到一个txt文件中，筛选代码行数超过10行的方法。</p>
<p>这个txt的hook就是使用 frida-trace 来完成的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida-trace -UF -o .txt</span><br></pre></td></tr></table></figure>



<p>自动生成的txt文件中全部是 -a 参数，-a 在frida-trace中表示hook后面的地址，就是相当于用frida来hook函数</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250519185710731.png" alt="image-20250519185710731"></p>
<p>执行一下会自动生成一些js文件，前面输出的 sub 偏移地址就是文件中的偏移地址</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250519191342968.png" alt="image-20250519191342968"></p>
<p>文件的内容也是比较简单的，就是简单的hook了当前地址，就是参数有点不一样，log就相当于 console.log ，args和正常hook 的含义相同</p>
<p>整个函数的hook和 <code>Interceptor.attach</code> 的作用是相同的，这个的执行就是为了查看函数的执行流程，因为他只在函数执行前打印函数的地址。</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250519191559123.png" alt="image-20250519191559123"></p>
<p>如图，会展示出一个清晰的函数调用顺序的流程图</p>
<img src="../图片/image-20250519192029777.png" alt="image-20250519192029777" style="zoom:50%;" />



<p>生成的js文件是可更改的，目录下没有对应的js文件时，执行 frida-trace 会自动生成一个 <code>Auto-generated</code> 如果已经存在了那就是加载 <code>Loaded</code> 也就是说这个流程图是可以在后期进行一些修改，再输出一些方法参数，函数的符号信息等等。</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250519192754371.png" alt="image-20250519192754371"></p>
<p>但是后期生成的文件有点多了貌似，手动改很麻烦的啊，而且重复性高，不如写个脚本改，有能力的大佬可以修改 frida-trace 的源码，再重新打包</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250519201523928.png" alt="image-20250519201523928"></p>
<p>我比较废物，只能写了一个小脚本来手动修改，想了半天因为so层函数的变量具有太多的不确定性了，需要手动进行分析，如果直接打印参数出来，反而会变的很乱，影响整个流程图的观看，所有就加了一个函数的符号表信息，方便查看函数名称。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">modify_js_files</span>(<span class="params">folder_path</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(folder_path):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;folder_path&#125;</span>路径不存在&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(folder_path):</span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">            <span class="keyword">if</span> file.endswith(<span class="string">&#x27;.js&#x27;</span>):</span><br><span class="line">                file_path = os.path.join(root, file)</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    content = f.readlines()</span><br><span class="line">                    <span class="comment"># print(content)</span></span><br><span class="line">                file_name = os.path.basename(file_path)</span><br><span class="line">                address = file_name.split(<span class="string">&#x27;_&#x27;</span>)[<span class="number">1</span>].split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(content) &gt; <span class="number">10</span>:</span><br><span class="line">                    soName = folder_path.split(<span class="string">&#x27;\\&#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line">                    content[<span class="number">9</span>] = <span class="string">f&quot;    var soAddr = Module.findBaseAddress(&#x27;<span class="subst">&#123;soName&#125;</span>&#x27;).add(0x<span class="subst">&#123;address&#125;</span>); \n    log(&#x27;<span class="subst">&#123;file_name.split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>]&#125;</span>&#x27; ,DebugSymbol.fromAddress(soAddr).name)\n&quot;</span></span><br><span class="line">                    <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                        f.writelines(content)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;已修改<span class="subst">&#123;file_name&#125;</span>文件内容&quot;</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;文件行数不足，请检查<span class="subst">&#123;file_name&#125;</span>文件内容&quot;</span>)</span><br></pre></td></tr></table></figure>





<h3 id="内存读写监控（了解）"><a href="#内存读写监控（了解）" class="headerlink" title="内存读写监控（了解）"></a>内存读写监控（了解）</h3><p>firda的内存读写监控了解即可，一般使用unidbg的内存读写监控</p>
<p>frida的读写监控是利用的一个异常处理函数</p>
<p><code>Process.setExceptionHandler</code> 注入之后只要触发异常就进入定义的方法，注意方法体内要对异常进行处理，然后返回 true，如果不处理返回 true，会陷入死循环</p>
<p>这个方法再配合 <code>Memory.protect</code> 修改内存权限的API</p>
<p><code>Memory.protect</code> 修改权限并不是修改某一个指针地址的权限，而是修改内存页的权限，因为内存过大的话，以字节为单位难以管理。因此内存是按照某一个单位来分内存页来进行管理的。比如说 4096字节一个单位</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">set_read_write_break</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Process</span>.<span class="title function_">setExceptionHandler</span>(<span class="keyword">function</span> (<span class="params">details</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(details, <span class="literal">null</span>, <span class="number">2</span>));</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;lr&#x27;</span>, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(details.<span class="property">context</span>.<span class="property">lr</span>));</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;pc&#x27;</span>, <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(details.<span class="property">context</span>.<span class="property">pc</span>));</span><br><span class="line">        <span class="title class_">Memory</span>.<span class="title function_">protect</span>(details.<span class="property">memory</span>.<span class="property">address</span>, <span class="title class_">Process</span>.<span class="property">pointerSize</span>, <span class="string">&#x27;rwx&#x27;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Thread</span>.<span class="title function_">backtrace</span>(details.<span class="property">context</span>, <span class="title class_">Backtracer</span>.<span class="property">ACCURATE</span>).<span class="title function_">map</span>(<span class="title class_">DebugSymbol</span>.<span class="property">fromAddress</span>).<span class="title function_">join</span>(<span class="string">&quot;\n&quot;</span>) + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">var</span> addr = <span class="title class_">Module</span>.<span class="title function_">findBaseAddress</span>(<span class="string">&#x27;libxiaojianbang.so&#x27;</span>).<span class="title function_">add</span>(<span class="number">0x3DE0</span>)</span><br><span class="line">    <span class="title class_">Memory</span>.<span class="title function_">protect</span>(addr, <span class="number">8</span>, <span class="string">&#x27;---&#x27;</span>)  <span class="comment">// 修改内存页权限</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>为什么说这两个可以监控内存读写呢，先给指定的地址的权限取消掉，如此这一段内存是不允许读写执行的，当有程序需要读、写、执行的话就会报无权限的错，这个时候再进入<code>Process.setExceptionHandler</code> 打印函数栈和寄存器信息，将权限变更为可读可写可执行，解决报错返回true，程序正常运行。</p>
<p>这种方法就是针对一个地址，通过权限问题来监控内存的读写情况。这种方式感觉和断点很像啊🤔</p>
<p>以此类推，构造一个异常就可以进行这个操作，不一定是非法访问异常</p>
<p>还支持中止（流产是什么鬼，蜜汁翻译），非法指令什么的</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250519211502144.png" alt="image-20250519211502144"></p>
<p>details中包含错误信息 <code>message</code> ，哪个地址访问的 <code>address</code> 访问的方式，以及访问错误的地址 <code>memory</code> ，寄存器信息 <code>context</code> </p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250519212015469.png" alt="image-20250519212015469"></p>
<p>这个东西的缺点还是很明显的，只能触发一次，只有首次内存访问的时候才会被监控，记录下来信息，报错之后会恢复权限，下次再执行就不会报错的。</p>
<p>而且根据提示访问无权限的信息，大概率不是给出的地址信息，只要和地址信息在同一个内存页的任何一行代码被访问到都会触发报错，并且代码触发后失效</p>
<p>挺鸡肋的，监控不够精确，了解即可</p>
<h2 id="Frida监测"><a href="#Frida监测" class="headerlink" title="Frida监测"></a>Frida监测</h2><p><img src="/../%E5%9B%BE%E7%89%87/image-20250519213431230.png" alt="image-20250519213431230"></p>
<h3 id="占坑式"><a href="#占坑式" class="headerlink" title="占坑式"></a>占坑式</h3><p>开启一个子进程附加父进程</p>
<p>一个app只能被一个进程附加，在app加载的时候自己附加自己，这样frida就无法附加了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ptrace(0,0,0,0)</span><br></pre></td></tr></table></figure>



<p>如果软件使用这种方法，进行 -UF 附加注入的话会报一个错误</p>
<p><code>Failed to attach: unable to access process with pid xxxx due to system restrictions; try sudo sysctl kernel.yama.ptrace_scope=0 , or run Frida as root</code> </p>
<p>我实操的时候报错是这样的，提示未找到进程</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250519215420099.png" alt="image-20250519215420099"></p>
<p>使用 -f 确实会注入成功，但是马上进程就会中止</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250519215329911.png" alt="image-20250519215329911"></p>
<p>这个时候就要稍微说一下两种方式的区别了，之前已经很熟悉的是 -f 会重新启动app -F 直接附加。</p>
<p>-f 注入的时候是先调用一下 ptrace 然后就释放了，而 -F 是一直 ptrace 附加在进程上，因此退出app frida会立即中断，而 -f 则不会</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250519215916472.png" alt="image-20250519215916472"></p>
<p>使用指令查看app进程情况</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -A |grep 包名</span><br></pre></td></tr></table></figure>



<p>看到有两个进程，下面是上面的附加进程，第一个数字是 pid 第二个是 ppid ppid表示该进程的父进程</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250519220254981.png" alt="image-20250519220254981"></p>
<p>但是呢，软件又会有附加进程的情况，不单是占坑防止frida。比如：</p>
<p>守护进程：防止app崩溃，保证app服务不会kill</p>
<p>普通双进程：单线程资源访问有限，虽然手机内存大，但是一个线程可以使用的资源是有限的，因此有时候会使用双进程，多进程，进程之间相互通信</p>
<p>还有就是防止注入了，其实也防不住，可以使用frida解决掉的，注入成功了就有操作空间的</p>
<p>对应多进程的app，可以使用 pid 来进行注入，因为多线程可能是有同名进程的 -f 是注入不了的</p>
<p>还可能会有进程名检测和端口检测</p>
<h4 id="进程名检测"><a href="#进程名检测" class="headerlink" title="进程名检测"></a>进程名检测</h4><p>进程名检测就属于是防君子不防小人了，操作就是遍历进程列表，找到疑似frida-server的，打死你hifrida-server的进程名就是文件的命名，避开frida-server的常规命名就检测不到了</p>
<p>我的命名就是frida-server，纯小白命名，可以根据自己的喜好微操一下</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250520175226846.png" alt="image-20250520175226846"></p>
<h4 id="端口检测"><a href="#端口检测" class="headerlink" title="端口检测"></a>端口检测</h4><p>frida-server的默认TCP端口是27042，检测27042端口是否开放，用处也不大，因为默认 27042 不一定就是 27042</p>
<h3 id="D-Bus协议通信"><a href="#D-Bus协议通信" class="headerlink" title="D-Bus协议通信"></a>D-Bus协议通信</h3><p>frida使用D-Bus协议通信，可以遍历 &#x2F;proc&#x2F;xxxx&#x2F;net&#x2F;tcp 文件（xxx表示app的pid，软件运行的时候才可以进入）</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250520180644721.png" alt="image-20250520180644721"></p>
<p>然后向每个端口发送D-Bus认证信息，哪个端口回复了 REJECT ，就是frida-server的端口</p>
<p>或者说之间遍历所有端口，发送认证信息</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250520180532824.png" alt="image-20250520180532824"></p>
<p>但是这个也是可以hook了，将 strcmp hook掉，更改第二个参数</p>
<h3 id="遍历maps"><a href="#遍历maps" class="headerlink" title="遍历maps"></a>遍历maps</h3><p>可以看到有被加载的so，之所以一个so可能会有多个，是因为so的权限不一样，但是地址是连续的 ，从797c2f9000 - 797c2fa000 - 797c2fb000</p>
<p>frida注入之后会出现 frida-agent.so，这个也是一个检测点</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250520181224549.png" alt="image-20250520181224549"></p>
<h3 id="扫描task目录"><a href="#扫描task目录" class="headerlink" title="扫描task目录"></a>扫描task目录</h3><p>task目录下有很多文件夹，表示app开启的线程</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250520181738858.png" alt="image-20250520181738858"></p>
<p>文件夹内的status文件中有一些信息</p>
<p>如果进程被附加了，这个 TracerPid 就不为 0</p>
<p>state 为 S 表示当前未被附加，也未被调试，被调试是 T</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250520182000589.png" alt="image-20250520182000589"></p>
<p>name为 gmain、gdbus、gum-js-loop、pool-frida 这些都是frida注入的特征</p>
<p><img src="/../%E5%9B%BE%E7%89%87/image-20250520182549554.png" alt="image-20250520182549554"></p>
<p>可以通过 readlink 方法查看 &#x2F;proc&#x2F;xxxx&#x2F;self&#x2F;fd、&#x2F;proc&#x2F;xxxx&#x2F;self&#x2F;task&#x2F;pid&#x2F;fd 下所有打开的文件，检测是否有frida相关的文件</p>
<p>还可以扫描内存中是否有frida库特征的存在，例如字符串 LIBFRIDA 。不同版本的特征还是有些不同的</p>
<p>常用于检测frida的函数有 &#x3D;&#x3D;strstr、strcmp、open、read、fread、readlink&#x3D;&#x3D;</p>
<p>函数都放这了，过frida检测就试试呗</p>
<h3 id="补充、总结"><a href="#补充、总结" class="headerlink" title="补充、总结"></a>补充、总结</h3><p>通常比较会被检测的文件</p>
<blockquote>
<p>riru的特征文件</p>
<p>​	&#x2F;system&#x2F;lib&#x2F;libmemtrack.so</p>
<p>​	&#x2F;system&#x2F;lib&#x2F;libmemtrack_real.so</p>
<p>cmdline 检测进程名，防止重打包</p>
<p>status 检测进程是否被附加</p>
<p>stat  检测进程是否被附加</p>
<p>task&#x2F;xxxx&#x2F;stat</p>
<p>task&#x2F;xxxx&#x2F;status   检测线程 name 是否包括                                                                                                                                                                                                                                         </p>
<p>fd&#x2F;xx   检测app是否打开了frida相关文件 （frida版本16.5.2，frdia注入之后好像没有看到frida相关文件，难道是优化了？）</p>
<p>maps  检测app是否加载的依赖库里是否有frida</p>
<p>net&#x2F;tcp  检测app开放的端口，进行 D-Bus协议通信</p>
<p>还有可能检测 &#x2F;data&#x2F;local&#x2F;tmp 目录，一般app是不会加载这个目录的，但是frdia-server一般都是放在这个目录。如果frida-server不放在  &#x2F;data&#x2F;local&#x2F;tmp 目录那么基本可以不用关心 fd 和 maps 的检测</p>
</blockquote>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91/" rel="tag"># 安卓逆向</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2025/07/09/%E7%BB%95%E8%BF%87libmsaoaidsec-so%E7%9A%84frida%E6%A3%80%E6%B5%8B/" rel="prev" title="绕过libmsaoaidsec.so的frida检测">
      <i class="fa fa-chevron-left"></i> 绕过libmsaoaidsec.so的frida检测
    </a></div>
      <div class="post-nav-item">
    <a href="/2025/07/24/%E9%80%86%E5%90%91%E5%AD%A6%E4%B9%A0-0x0D-%E7%AE%97%E6%B3%95%E8%BD%AC%E5%8F%91/" rel="next" title="逆向学习 0x0D 算法转发">
      逆向学习 0x0D 算法转发 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#so%E9%80%86%E5%90%91%E5%88%86%E6%9E%90"><span class="nav-number">1.</span> <span class="nav-text">so逆向分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%9A%E4%B8%BE"><span class="nav-number">1.1.</span> <span class="nav-text">枚举</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hook%E5%AF%BC%E5%87%BA%E5%87%BD%E6%95%B0"><span class="nav-number">1.2.</span> <span class="nav-text">hook导出函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E5%9F%BA%E5%9D%80%E7%9A%84%E8%8E%B7%E5%8F%96%E6%96%B9%E5%BC%8F"><span class="nav-number">1.3.</span> <span class="nav-text">模块基址的获取方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E5%9C%B0%E5%9D%80%E8%AE%A1%E7%AE%97"><span class="nav-number">1.4.</span> <span class="nav-text">函数地址计算</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%81%E8%A3%85hook"><span class="nav-number">1.5.</span> <span class="nav-text">封装hook</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E6%88%98"><span class="nav-number">1.6.</span> <span class="nav-text">实战</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B7%98%E6%9C%80%E7%83%AD%E7%82%B9"><span class="nav-number">1.6.1.</span> <span class="nav-text">淘最热点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%A9%AC%E8%9C%82%E7%AA%9D"><span class="nav-number">1.6.2.</span> <span class="nav-text">马蜂窝</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%87%E7%AE%80%E5%8D%95root%E6%A3%80%E6%B5%8B%EF%BC%88%E6%B5%B7%E5%8D%9ATV%EF%BC%89"><span class="nav-number">1.6.3.</span> <span class="nav-text">过简单root检测（海博TV）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BA%8C%E7%BA%A7%E6%8C%87%E9%92%88"><span class="nav-number">1.6.3.1.</span> <span class="nav-text">二级指针</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%96%9C%E9%A9%AC%E6%8B%89%E9%9B%85%EF%BC%88jnitrace%EF%BC%89"><span class="nav-number">1.6.4.</span> <span class="nav-text">喜马拉雅（jnitrace）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#jnitrace"><span class="nav-number">1.6.4.1.</span> <span class="nav-text">jnitrace</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ollvm%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%A7%A3%E5%AF%86"><span class="nav-number">1.6.4.2.</span> <span class="nav-text">ollvm字符串解密</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#so-dump"><span class="nav-number">1.6.4.3.</span> <span class="nav-text">so dump</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#so%E4%BF%AE%E5%A4%8D"><span class="nav-number">1.6.4.4.</span> <span class="nav-text">so修复</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#so%E4%BD%95%E6%97%B6%E8%A2%AB%E5%8A%A0%E8%BD%BD%EF%BC%9F"><span class="nav-number">1.6.4.5.</span> <span class="nav-text">so何时被加载？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E5%87%BD%E6%95%B0%E6%95%B0%E5%80%BC%E5%8F%82%E6%95%B0%E5%92%8C%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="nav-number">1.7.</span> <span class="nav-text">修改函数数值参数和返回值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8F%82%E6%95%B0"><span class="nav-number">1.8.</span> <span class="nav-text">修改字符串参数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#function-1-%E4%BF%AE%E6%94%B9%E5%9C%B0%E5%9D%80%E6%8C%87%E5%90%91%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="nav-number">1.8.1.</span> <span class="nav-text">function 1 修改地址指向的字符串（了解）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#function-2-%E4%BF%AE%E6%94%B9%E5%9C%B0%E5%9D%80%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="nav-number">1.8.2.</span> <span class="nav-text">function 2 修改地址（了解）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#function-3-%E4%BF%AE%E6%94%B9%E7%BB%93%E6%9E%84%E4%BD%93%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="nav-number">1.8.3.</span> <span class="nav-text">function 3 修改结构体（了解）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#function-4-%E6%9E%84%E5%BB%BA%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%88%E9%87%8D%E8%A6%81%EF%BC%89"><span class="nav-number">1.8.4.</span> <span class="nav-text">function 4 构建字符串（重要）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hook-dlopen"><span class="nav-number">1.9.</span> <span class="nav-text">hook_dlopen</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E8%AF%BB%E5%86%99"><span class="nav-number">1.10.</span> <span class="nav-text">内存读写</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%BB"><span class="nav-number">1.10.1.</span> <span class="nav-text">读</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%99"><span class="nav-number">1.10.2.</span> <span class="nav-text">写</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ARM%E6%B1%87%E7%BC%96"><span class="nav-number">1.11.</span> <span class="nav-text">ARM汇编</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#frida%E4%BF%AE%E6%94%B9so%E5%B1%82%E4%BB%A3%E7%A0%81"><span class="nav-number">1.12.</span> <span class="nav-text">frida修改so层代码</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8writer"><span class="nav-number">1.12.1.</span> <span class="nav-text">使用writer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8frida-API"><span class="nav-number">1.12.2.</span> <span class="nav-text">使用frida API</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Memory-patchCode"><span class="nav-number">1.12.3.</span> <span class="nav-text">使用Memory.patchCode</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#so%E4%B8%BB%E5%8A%A8%E8%B0%83%E7%94%A8"><span class="nav-number">1.13.</span> <span class="nav-text">so主动调用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A3%B0%E6%98%8E%E5%87%BD%E6%95%B0%E6%8C%87%E9%92%88"><span class="nav-number">1.13.1.</span> <span class="nav-text">声明函数指针</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E5%8F%82%E6%95%B0"><span class="nav-number">1.13.2.</span> <span class="nav-text">构建参数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hook-libc-%E8%AF%BB%E5%86%99%E6%96%87%E4%BB%B6"><span class="nav-number">1.14.</span> <span class="nav-text">hook libc 读写文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#jni%E5%87%BD%E6%95%B0%E7%9A%84hook"><span class="nav-number">1.15.</span> <span class="nav-text">jni函数的hook</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#hook-libart"><span class="nav-number">1.15.1.</span> <span class="nav-text">hook libart</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9E%9A%E4%B8%BE%E7%AC%A6%E5%8F%B7%E8%A1%A8"><span class="nav-number">1.15.1.1.</span> <span class="nav-text">枚举符号表</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%A1%E7%AE%97%E5%9C%B0%E5%9D%80"><span class="nav-number">1.15.2.</span> <span class="nav-text">计算地址</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E5%8A%A8%E8%B0%83%E7%94%A8jni%E5%87%BD%E6%95%B0"><span class="nav-number">1.16.</span> <span class="nav-text">主动调用jni函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#f1-%E4%BD%BF%E7%94%A8frida%E5%B0%81%E8%A3%85%E7%9A%84%E5%87%BD%E6%95%B0%E6%9D%A5%E8%B0%83%E7%94%A8jni"><span class="nav-number">1.16.1.</span> <span class="nav-text">f1:使用frida封装的函数来调用jni</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#f2-%E4%BD%BF%E7%94%A8nativefunction%E6%96%B9%E5%BC%8F%E8%B0%83%E7%94%A8"><span class="nav-number">1.16.2.</span> <span class="nav-text">f2:使用nativefunction方式调用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E4%BA%8C%E7%BA%A7%E6%8C%87%E9%92%88"><span class="nav-number">1.16.3.</span> <span class="nav-text">构建二级指针</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A0%86%E6%A0%88%E6%89%93%E5%8D%B0"><span class="nav-number">1.17.</span> <span class="nav-text">堆栈打印</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A1%AE%E8%AE%A4native%E5%87%BD%E6%95%B0%E5%9C%A8%E5%93%AA%E4%B8%AAso%E4%B8%AD"><span class="nav-number">1.18.</span> <span class="nav-text">确认native函数在哪个so中</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#hook-dlsym-%E9%9D%99%E6%80%81%E6%B3%A8%E5%86%8C"><span class="nav-number">1.18.1.</span> <span class="nav-text">hook dlsym  静态注册</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#hook-RegisterNative-%E5%8A%A8%E6%80%81%E6%B3%A8%E5%86%8C"><span class="nav-number">1.18.2.</span> <span class="nav-text">hook RegisterNative 动态注册</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#inline-hook"><span class="nav-number">1.19.</span> <span class="nav-text">inline hook</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ART%E4%B8%8B%E7%9A%84System-loadLibrary"><span class="nav-number">1.20.</span> <span class="nav-text">ART下的System.loadLibrary</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hook-initarray"><span class="nav-number">1.21.</span> <span class="nav-text">hook_initarray</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hook-JNIOnload"><span class="nav-number">1.22.</span> <span class="nav-text">hook_JNIOnload</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hook-pthread-create%EF%BC%88%E5%A4%9A%E7%BA%BF%E7%A8%8B%EF%BC%89"><span class="nav-number">1.23.</span> <span class="nav-text">hook_pthread_create（多线程）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9B%BF%E6%8D%A2%E5%87%BD%E6%95%B0"><span class="nav-number">1.24.</span> <span class="nav-text">替换函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hexdump"><span class="nav-number">1.25.</span> <span class="nav-text">hexdump</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#frida-trace"><span class="nav-number">1.26.</span> <span class="nav-text">frida-trace</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E8%AF%BB%E5%86%99%E7%9B%91%E6%8E%A7%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="nav-number">1.27.</span> <span class="nav-text">内存读写监控（了解）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Frida%E7%9B%91%E6%B5%8B"><span class="nav-number">2.</span> <span class="nav-text">Frida监测</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%A0%E5%9D%91%E5%BC%8F"><span class="nav-number">2.1.</span> <span class="nav-text">占坑式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E5%90%8D%E6%A3%80%E6%B5%8B"><span class="nav-number">2.1.1.</span> <span class="nav-text">进程名检测</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AB%AF%E5%8F%A3%E6%A3%80%E6%B5%8B"><span class="nav-number">2.1.2.</span> <span class="nav-text">端口检测</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#D-Bus%E5%8D%8F%E8%AE%AE%E9%80%9A%E4%BF%A1"><span class="nav-number">2.2.</span> <span class="nav-text">D-Bus协议通信</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%81%8D%E5%8E%86maps"><span class="nav-number">2.3.</span> <span class="nav-text">遍历maps</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%AB%E6%8F%8Ftask%E7%9B%AE%E5%BD%95"><span class="nav-number">2.4.</span> <span class="nav-text">扫描task目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A1%A5%E5%85%85%E3%80%81%E6%80%BB%E7%BB%93"><span class="nav-number">2.5.</span> <span class="nav-text">补充、总结</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="没事数命的猫"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">没事数命的猫</p>
  <div class="site-description" itemprop="description">学而不思则罔</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">30</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">没事数命的猫</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">182k</span>
</div>

<!--
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

-->

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>

<!-- 点击效果 -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script type="text/javascript" src="/js/love-click.js"></script>